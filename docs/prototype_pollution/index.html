<!doctype html><html lang=ja dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Prototype Pollution # 概要 # JavaScriptでは主に&#34;継承&#34;を実現するための__proto__プロパティが存在します。 Prototype Pollutionは、この__proto__プロパティを通じて特定のオブジェクトの内容を不正に変更する攻撃手法またはそれに対する脆弱性です。
影響 # Prototype Pollutionの影響は、さまざまで発生箇所やアプリケーションのロジックに依存します。 最悪の場合ではサーバサイドでの任意コード実行につながることがあり、そのほかの場合ではXSSやSQLインジェクションなどの脆弱性にもつながる可能性があります。
原因 # 攻撃者が__proto__プロパティなどを経由して、特定のオブジェクトのprototypeを操作可能であることがPrototype Pollutionの原因です。
攻撃手法 # 実際にオブジェクトの__proto__プロパティが操作可能なケースとして、下記2つの例を紹介します。
オブジェクトに対してmergeやcloneの操作をするケース setValue(obj, key, value)のようにオブジェクトのプロパティを設定するケース 1. オブジェクトに対してmergeやcloneの操作を行うケース # 以下のmerge(tgt, src)は、引数のtgtオブジェクトにsrcのプロパティを再帰的にマージします。 この実装では与えられたオブジェクトのkeyの値をチェックしておらず、任意のkeyに対して任意の値を代入できます。(10行目)
function isObject(obj) { return obj !== null && typeof obj === 'object'; } function merge(tgt, src) { for (let key in src) { if (isObject(tgt[key]) && isObject(src[key])) { merge(tgt[key], src[key]); } else { tgt[key] = src[key]; } } return tgt; } merge( {a: 1, b: 2}, JSON."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="Prototype Pollution"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://webapppentestguidelines.github.io/newtechtestdoc/docs/prototype_pollution/"><title>Prototype Pollution | WebApp Testing</title>
<link rel=manifest href=/newtechtestdoc/manifest.json><link rel=icon href=/newtechtestdoc/favicon.png type=image/x-icon><link rel=stylesheet href=/newtechtestdoc/book.min.c58292d36b18b675680ab9baea2029204537b839ea72f258746ec0f32ce8d6c8.css integrity="sha256-xYKS02sYtnVoCrm66iApIEU3uDnqcvJYdG7A8yzo1sg=" crossorigin=anonymous><script defer src=/newtechtestdoc/flexsearch.min.js></script><script defer src=/newtechtestdoc/ja.search.min.5a5f26882697f1482eb670388b0798730800d544aebcd385c8846f892c1c23e4.js integrity="sha256-Wl8miCaX8UgutnA4iweYcwgA1USuvNOFyIRviSwcI+Q=" crossorigin=anonymous></script><script defer src=/newtechtestdoc/sw.min.a87e9a69c1c9637cd6edeaed247d3a7735fae81f6bc6668f69a2cc0a283426ec.js integrity="sha256-qH6aacHJY3zW7ertJH06dzX66B9rxmaPaaLMCig0Juw=" crossorigin=anonymous></script><link rel=alternate type=application/rss+xml href=https://webapppentestguidelines.github.io/newtechtestdoc/docs/prototype_pollution/index.xml title="WebApp Testing"></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/newtechtestdoc/><span>WebApp Testing</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=検索 aria-label=検索 maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/newtechtestdoc/docs/nosql_injection/>NoSQL Injection</a><ul></ul></li><li><a href=/newtechtestdoc/docs/oauth/>OAuth/OpenID Connect</a><ul></ul></li><li><a href=/newtechtestdoc/docs/prototype_pollution/ class=active>Prototype Pollution</a><ul></ul></li><li><a href=/newtechtestdoc/docs/toctou/>TOCTOU/レースコンディション</a><ul></ul></li><li><a href=/newtechtestdoc/docs/cloudsec/>クラウドサービスにおけるWebサービスにまつわる脆弱性</a><ul><li><a href=/newtechtestdoc/docs/cloudsec/idaas/>IDaaSの活用に起因する脆弱性とその悪用</a><ul><li><a href=/newtechtestdoc/docs/cloudsec/idaas/edos/>EDoS(Economic Denial of Sustainability) - IDaaS</a></li><li><a href=/newtechtestdoc/docs/cloudsec/idaas/modify_custom_attributes_for_permissions/>アプリケーションの権限に関するカスタム属性の変更 - IDaaS</a></li><li><a href=/newtechtestdoc/docs/cloudsec/idaas/default_error/>デフォルトエラーに起因するユーザーの開示 - IDaaS</a></li><li><a href=/newtechtestdoc/docs/cloudsec/idaas/presence_of_unintended_signup_paths/>意図しないサインアップ経路の存在 - IDaaS</a></li></ul></li><li><a href=/newtechtestdoc/docs/cloudsec/faas/>FaaSにおける設定不備と脆弱性の悪用</a></li><li><a href=/newtechtestdoc/docs/cloudsec/cloud_credential/>Webアプリケーションの脆弱性を利用した認証情報の窃取</a></li><li><a href=/newtechtestdoc/docs/cloudsec/storage_service/>クラウドストレージサービスにおける設定不備</a></li></ul></li><li><a href=/newtechtestdoc/docs/web_cache_poisoning/>Web Cache Poisoning</a><ul></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/newtechtestdoc/svg/menu.svg class=book-icon alt=Menu>
</label><strong>Prototype Pollution</strong>
<label for=toc-control><img src=/newtechtestdoc/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#概要>概要</a></li><li><a href=#影響>影響</a></li><li><a href=#原因>原因</a></li><li><a href=#攻撃手法>攻撃手法</a><ul><li><a href=#1-オブジェクトに対してmergeやcloneの操作を行うケース>1. オブジェクトに対してmergeやcloneの操作を行うケース</a></li><li><a href=#2-setvalueobj-key-valueのようにオブジェクトのプロパティを設定するケース>2. <code>setValue(obj, key, value)</code>のようにオブジェクトのプロパティを設定するケース</a></li></ul></li><li><a href=#事例紹介>事例紹介</a></li><li><a href=#対策>対策</a><ul><li><a href=#ライブラリを利用する方法>ライブラリを利用する方法</a></li><li><a href=#objectfreezeを使用する方法><code>Object.freeze</code>を使用する方法</a></li><li><a href=#objectの代わりにmapを使う方法><code>Object</code>の代わりに<code>Map</code>を使う方法</a></li><li><a href=#オブジェクトの作成をobjectcreatenullで行う方法>オブジェクトの作成を<code>Object.create(null)</code>で行う方法</a></li><li><a href=#schema-validation-of-json-input>Schema validation of JSON input</a></li></ul></li><li><a href=#診断方法>診断方法</a><ul><li><a href=#基本的な診断方法>基本的な診断方法</a></li><li><a href=#dom-invaderを用いた効率的な診断>DOM Invaderを用いた効率的な診断</a></li></ul></li><li><a href=#学習方法参考文献>学習方法/参考文献</a></li></ul></nav></aside></header><article class=markdown><h1 id=prototype-pollution>Prototype Pollution
<a class=anchor href=#prototype-pollution>#</a></h1><h2 id=概要>概要
<a class=anchor href=#%e6%a6%82%e8%a6%81>#</a></h2><p>JavaScriptでは主に"継承"を実現するための<a href=https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Object/proto><code>__proto__</code></a>プロパティが存在します。
Prototype Pollutionは、この<code>__proto__</code>プロパティを通じて特定のオブジェクトの内容を不正に変更する攻撃手法またはそれに対する脆弱性です。</p><h2 id=影響>影響
<a class=anchor href=#%e5%bd%b1%e9%9f%bf>#</a></h2><p>Prototype Pollutionの影響は、さまざまで発生箇所やアプリケーションのロジックに依存します。
最悪の場合ではサーバサイドでの任意コード実行につながることがあり、そのほかの場合ではXSSやSQLインジェクションなどの脆弱性にもつながる可能性があります。</p><h2 id=原因>原因
<a class=anchor href=#%e5%8e%9f%e5%9b%a0>#</a></h2><p>攻撃者が<code>__proto__</code>プロパティなどを経由して、特定のオブジェクトのprototypeを操作可能であることがPrototype Pollutionの原因です。</p><h2 id=攻撃手法>攻撃手法
<a class=anchor href=#%e6%94%bb%e6%92%83%e6%89%8b%e6%b3%95>#</a></h2><p>実際にオブジェクトの<code>__proto__</code>プロパティが操作可能なケースとして、下記2つの例を紹介します。</p><ol><li>オブジェクトに対してmergeやcloneの操作をするケース</li><li><code>setValue(obj, key, value)</code>のようにオブジェクトのプロパティを設定するケース</li></ol><h3 id=1-オブジェクトに対してmergeやcloneの操作を行うケース>1. オブジェクトに対してmergeやcloneの操作を行うケース
<a class=anchor href=#1-%e3%82%aa%e3%83%96%e3%82%b8%e3%82%a7%e3%82%af%e3%83%88%e3%81%ab%e5%af%be%e3%81%97%e3%81%a6merge%e3%82%84clone%e3%81%ae%e6%93%8d%e4%bd%9c%e3%82%92%e8%a1%8c%e3%81%86%e3%82%b1%e3%83%bc%e3%82%b9>#</a></h3><p>以下の<code>merge(tgt, src)</code>は、引数の<code>tgt</code>オブジェクトに<code>src</code>のプロパティを再帰的にマージします。
この実装では与えられたオブジェクトの<code>key</code>の値をチェックしておらず、任意の<code>key</code>に対して任意の値を代入できます。(10行目)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>isObject</span>(<span style=color:#a6e22e>obj</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>obj</span> <span style=color:#f92672>!==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>obj</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;object&#39;</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>merge</span>(<span style=color:#a6e22e>tgt</span>, <span style=color:#a6e22e>src</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>key</span> <span style=color:#66d9ef>in</span> <span style=color:#a6e22e>src</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>isObject</span>(<span style=color:#a6e22e>tgt</span>[<span style=color:#a6e22e>key</span>]) <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>isObject</span>(<span style=color:#a6e22e>src</span>[<span style=color:#a6e22e>key</span>])) {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>merge</span>(<span style=color:#a6e22e>tgt</span>[<span style=color:#a6e22e>key</span>], <span style=color:#a6e22e>src</span>[<span style=color:#a6e22e>key</span>]);
</span></span><span style=display:flex><span>        } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>tgt</span>[<span style=color:#a6e22e>key</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>src</span>[<span style=color:#a6e22e>key</span>];
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>tgt</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>merge</span>(
</span></span><span style=display:flex><span>    {<span style=color:#a6e22e>a</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>b</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>2</span>},
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>JSON</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#e6db74>&#39;{&#34;__proto__&#34;: {&#34;polluted&#34;: 1}}&#39;</span>)
</span></span><span style=display:flex><span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>obj</span> <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>obj</span>.<span style=color:#a6e22e>polluted</span>); <span style=color:#75715e>// =&gt; 1
</span></span></span></code></pre></div><p>上記のPoCでは、引数<code>src</code>に<code>{"__proto__": {"polluted": 1}}</code>というオブジェクトを渡しています。その値を10行目で<code>tgt[__proto__] = {"polluted":1}</code>のような代入が実行されることで攻撃が成功しています。</p><h3 id=2-setvalueobj-key-valueのようにオブジェクトのプロパティを設定するケース>2. <code>setValue(obj, key, value)</code>のようにオブジェクトのプロパティを設定するケース
<a class=anchor href=#2-setvalueobj-key-value%e3%81%ae%e3%82%88%e3%81%86%e3%81%ab%e3%82%aa%e3%83%96%e3%82%b8%e3%82%a7%e3%82%af%e3%83%88%e3%81%ae%e3%83%97%e3%83%ad%e3%83%91%e3%83%86%e3%82%a3%e3%82%92%e8%a8%ad%e5%ae%9a%e3%81%99%e3%82%8b%e3%82%b1%e3%83%bc%e3%82%b9>#</a></h3><p>以下の<code>setValue(obj, key, value)</code>は、引数の<code>obj</code>オブジェクトに<code>{key:value}</code>のプロパティを追加します。また、<code>key</code>にチェーン演算子を用いて指定することで深くに位置するプロパティを追加します。</p><p>この実装でも引数<code>key</code>の値をチェックしておらず、任意の<code>key</code>に対して任意の値を代入できます。(13行目)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>isObject</span>(<span style=color:#a6e22e>obj</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>obj</span> <span style=color:#f92672>!==</span> <span style=color:#66d9ef>null</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#66d9ef>typeof</span> <span style=color:#a6e22e>obj</span> <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;object&#39;</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>setValue</span>(<span style=color:#a6e22e>obj</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keylist</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>key</span>.<span style=color:#a6e22e>split</span>(<span style=color:#e6db74>&#39;.&#39;</span>);
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>e</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>keylist</span>.<span style=color:#a6e22e>shift</span>();
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>keylist</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>isObject</span>(<span style=color:#a6e22e>obj</span>[<span style=color:#a6e22e>e</span>])) <span style=color:#a6e22e>obj</span>[<span style=color:#a6e22e>e</span>] <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>setValue</span>(<span style=color:#a6e22e>obj</span>[<span style=color:#a6e22e>e</span>], <span style=color:#a6e22e>keylist</span>.<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#39;.&#39;</span>), <span style=color:#a6e22e>value</span>);
</span></span><span style=display:flex><span>    } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>obj</span>[<span style=color:#a6e22e>key</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>value</span>;
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>obj</span>;
</span></span><span style=display:flex><span>    }}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>setValue</span>({}, <span style=color:#e6db74>&#34;__proto__.polluted&#34;</span>, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>a</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>polluted</span>); <span style=color:#75715e>// =&gt; 1
</span></span></span></code></pre></div><p>上記のPoCでは、引数<code>key</code>に<code>__proto__.polluted</code>という値を渡しています。その値が再帰的に処理されることで結果的に13行目で<code>obj[__proto__][polluted] = 1</code>のような代入が実行されることで攻撃が成功しています。</p><h2 id=事例紹介>事例紹介
<a class=anchor href=#%e4%ba%8b%e4%be%8b%e7%b4%b9%e4%bb%8b>#</a></h2><ul><li><a href=https://nvd.nist.gov/vuln/detail/cve-2019-7609>NVD - cve-2019-7609</a></li><li><a href=https://hackerone.com/reports/1106238>#1106238 Stored XSS via Mermaid Prototype Pollution vulnerability</a></li><li><a href=https://hackerone.com/reports/454365>#454365 Prototype pollution attack through jQuery $.extend</a></li></ul><h2 id=対策>対策
<a class=anchor href=#%e5%af%be%e7%ad%96>#</a></h2><p>Prototype Pollutionの対策にはいくつか方法があるため、アプリケーションの規模や副作用を考慮して、適切な対策を選択するようにしてください。
ここでは代表的な下記5つの方法を紹介します。</p><ul><li>ライブラリを利用する方法</li><li><code>Object.freeze</code>を使用する方法</li><li><code>Object</code>の代わりに<code>Map</code>を使う方法</li><li>オブジェクトの作成を<code>Object.create(null)</code>で行う方法</li><li>Schema validation of JSON input</li></ul><h3 id=ライブラリを利用する方法>ライブラリを利用する方法
<a class=anchor href=#%e3%83%a9%e3%82%a4%e3%83%96%e3%83%a9%e3%83%aa%e3%82%92%e5%88%a9%e7%94%a8%e3%81%99%e3%82%8b%e6%96%b9%e6%b3%95>#</a></h3><p>要件を満たす場合、Prototype Pollutionの影響を受けずにオブジェクトに対してmergeやcloneを行うライブラリを利用することで防ぐことができます。</p><h3 id=objectfreezeを使用する方法><code>Object.freeze</code>を使用する方法
<a class=anchor href=#objectfreeze%e3%82%92%e4%bd%bf%e7%94%a8%e3%81%99%e3%82%8b%e6%96%b9%e6%b3%95>#</a></h3><p><a href=https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Object/freeze>Object.freeze()</a>を使用して、ObjectやObject.prototypeを変更できないようにすることで、prototypeが意図せず汚染されないようにできます。</p><p>下記のコードは、実際に<code>Object.freeze()</code>を使用して実際に対策できることを示すPoCです。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span>Object.<span style=color:#a6e22e>freeze</span>(Object.<span style=color:#a6e22e>prototype</span>);
</span></span><span style=display:flex><span>Object.<span style=color:#a6e22e>freeze</span>(Object);
</span></span><span style=display:flex><span>({}.<span style=color:#a6e22e>__proto__</span>.<span style=color:#a6e22e>test</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>123</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>({}.<span style=color:#a6e22e>test</span>); <span style=color:#75715e>// =&gt; undefined
</span></span></span></code></pre></div><p>なお、注意点として、（上記のPoCを実際に動かしてみてもわかる通り、）<code>Object.freeze()</code>によってfreezeされたオブジェクトの変更は、特にエラーや例外が起こることなく失敗します。
そのため、本対策を適用し意図しない副作用が発生した場合でも、その発見が困難な場合もあります。
したがって、この対策は（依存ライブラリを含めた）アプリケーションの現状の実装を考慮して、慎重に適用することを推奨します。</p><h3 id=objectの代わりにmapを使う方法><code>Object</code>の代わりに<code>Map</code>を使う方法
<a class=anchor href=#object%e3%81%ae%e4%bb%a3%e3%82%8f%e3%82%8a%e3%81%abmap%e3%82%92%e4%bd%bf%e3%81%86%e6%96%b9%e6%b3%95>#</a></h3><p>ES6以降では、<code>Object</code>の代わりに<code>Map</code>が利用できます。
<code>Object</code>で単純にkey/valueのデータ構造を利用している場合は、それらを<code>Map</code>に置き換えることで、Prototype Pollutionを防ぐことができます。</p><h3 id=オブジェクトの作成をobjectcreatenullで行う方法>オブジェクトの作成を<code>Object.create(null)</code>で行う方法
<a class=anchor href=#%e3%82%aa%e3%83%96%e3%82%b8%e3%82%a7%e3%82%af%e3%83%88%e3%81%ae%e4%bd%9c%e6%88%90%e3%82%92objectcreatenull%e3%81%a7%e8%a1%8c%e3%81%86%e6%96%b9%e6%b3%95>#</a></h3><p><code>Object.create()</code>に<code>null</code>を渡し、prototypeを引き継がないオブジェクトを作成することで、<code>__proto__</code>経由でprototypeが汚染されることを防ぐことができます。
下記のようなコードで、実際に<code>__proto__</code>経由でprototypeにアクセスできないことを実際に確認できます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>obj</span> <span style=color:#f92672>=</span> Object.<span style=color:#a6e22e>create</span>(<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>obj</span>.<span style=color:#a6e22e>__proto__</span> <span style=color:#f92672>===</span> Object.<span style=color:#a6e22e>prototype</span>); <span style=color:#75715e>// =&gt; false
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>obj</span>.<span style=color:#a6e22e>__proto__</span>); <span style=color:#75715e>// =&gt; undefined
</span></span></span></code></pre></div><p>もし<code>{"a": 1, "b": 2}</code>のようなもともといくつかのプロパティを持つオブジェクトを作成する場合は、下記のように<a href=https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Object/assign><code>Object.assign()</code></a>を併せて利用する必要があります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>obj</span> <span style=color:#f92672>=</span> Object.<span style=color:#a6e22e>assign</span>(Object.<span style=color:#a6e22e>create</span>(<span style=color:#66d9ef>null</span>), { <span style=color:#a6e22e>a</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1</span>, <span style=color:#a6e22e>b</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>2</span> });
</span></span></code></pre></div><p>なお、このように作成されたオブジェクトのprototypeは<code>Object.prototype</code>の参照ではありません。そのため、<code>hasOwnProperty()</code>のような<code>Object.prototype</code>のメソッドはプロトタイプチェーン経由で呼び出せません。
もし、そのようなメソッドを呼び出したい場合は<code>Object.prototype.hasOwnProperty</code>のように明記する必要があります。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>obj</span> <span style=color:#f92672>=</span> Object.<span style=color:#a6e22e>create</span>(<span style=color:#66d9ef>null</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>obj</span>.<span style=color:#a6e22e>a</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>Object.<span style=color:#a6e22e>prototype</span>.<span style=color:#a6e22e>hasOwnProperty</span>.<span style=color:#a6e22e>call</span>(<span style=color:#a6e22e>obj</span>, <span style=color:#e6db74>&#34;a&#34;</span>); <span style=color:#75715e>// =&gt; true
</span></span></span></code></pre></div><p><code>Object.create(null)</code>による本対策を適用する場合は、このような副作用に留意してください。</p><h3 id=schema-validation-of-json-input>Schema validation of JSON input
<a class=anchor href=#schema-validation-of-json-input>#</a></h3><p><a href=https://json-schema.org/>JSON Schema</a>では<code>additionalProperties:false</code>を指定することで、想定していないプロパティを禁止できます。
適切なJSON Schemeを用いてバリデーションを行うことでPrototype Pollutionの対策ができます。</p><p>以下は、前述の関数<code>setValue()</code>に対し、<a href=https://ajv.js.org/>ajv</a>を用いて対策する例です。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>schema</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;object&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>properties</span><span style=color:#f92672>:</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 想定しているプロパティ
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  },
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>additionalProperties</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>false</span>,
</span></span><span style=display:flex><span>};
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>validate</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>ajv</span>.<span style=color:#a6e22e>compile</span>(<span style=color:#a6e22e>schema</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>setValue</span>(<span style=color:#a6e22e>obj</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keylist</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>key</span>.<span style=color:#a6e22e>split</span>(<span style=color:#e6db74>&#34;.&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>e</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>keylist</span>.<span style=color:#a6e22e>shift</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>keylist</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>isObject</span>(<span style=color:#a6e22e>obj</span>[<span style=color:#a6e22e>e</span>])) <span style=color:#a6e22e>obj</span>[<span style=color:#a6e22e>e</span>] <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>setValue</span>(<span style=color:#a6e22e>obj</span>[<span style=color:#a6e22e>e</span>], <span style=color:#a6e22e>keylist</span>.<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#34;.&#34;</span>), <span style=color:#a6e22e>value</span>);
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>obj</span>[<span style=color:#a6e22e>key</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>value</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>validate</span>(<span style=color:#a6e22e>obj</span>)) {
</span></span><span style=display:flex><span>      <span style=color:#75715e>// handling
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>      <span style=color:#66d9ef>throw</span> <span style=color:#e6db74>&#34;Invalid Obj&#34;</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>obj</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>setValue</span>({}, <span style=color:#e6db74>&#34;__proto__.polluted&#34;</span>, <span style=color:#ae81ff>1</span>); <span style=color:#75715e>// =&gt; Exception raised
</span></span></span></code></pre></div><p>ただし、この場合、<code>properties</code>に含んでいないプロパティは一切追加ができなくなることに注意が必要です。
任意のプロパティを受け入れつつ対策をする場合、単に追加されるkeyに悪意のある値が指定されないように制限する対策も有効です。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>setValue</span>(<span style=color:#a6e22e>obj</span>, <span style=color:#a6e22e>key</span>, <span style=color:#a6e22e>value</span>) {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>keylist</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>key</span>.<span style=color:#a6e22e>split</span>(<span style=color:#e6db74>&#34;.&#34;</span>);
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>e</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>keylist</span>.<span style=color:#a6e22e>shift</span>();
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>keylist</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>isObject</span>(<span style=color:#a6e22e>obj</span>[<span style=color:#a6e22e>e</span>])) <span style=color:#a6e22e>obj</span>[<span style=color:#a6e22e>e</span>] <span style=color:#f92672>=</span> {};
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>e</span> <span style=color:#f92672>!==</span> <span style=color:#e6db74>&#34;__proto__&#34;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>e</span> <span style=color:#f92672>!==</span> <span style=color:#e6db74>&#34;constructor&#34;</span>) {
</span></span><span style=display:flex><span>      <span style=color:#a6e22e>setValue</span>(<span style=color:#a6e22e>obj</span>[<span style=color:#a6e22e>e</span>], <span style=color:#a6e22e>keylist</span>.<span style=color:#a6e22e>join</span>(<span style=color:#e6db74>&#34;.&#34;</span>), <span style=color:#a6e22e>value</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  } <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>obj</span>[<span style=color:#a6e22e>key</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>value</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>obj</span>;
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>setValue</span>({}, <span style=color:#e6db74>&#34;__proto__.polluted&#34;</span>, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>a</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&#34;</span>;
</span></span><span style=display:flex><span><span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>polluted</span>); <span style=color:#75715e>// =&gt; undefined
</span></span></span></code></pre></div><h2 id=診断方法>診断方法
<a class=anchor href=#%e8%a8%ba%e6%96%ad%e6%96%b9%e6%b3%95>#</a></h2><h3 id=基本的な診断方法>基本的な診断方法
<a class=anchor href=#%e5%9f%ba%e6%9c%ac%e7%9a%84%e3%81%aa%e8%a8%ba%e6%96%ad%e6%96%b9%e6%b3%95>#</a></h3><p>これまでに説明したPrototype Pollutionの基本原理や攻撃手法などを踏まえ、任意のオブジェクトのprototypeが不正に変更できないかを検証してください。</p><h3 id=dom-invaderを用いた効率的な診断>DOM Invaderを用いた効率的な診断
<a class=anchor href=#dom-invader%e3%82%92%e7%94%a8%e3%81%84%e3%81%9f%e5%8a%b9%e7%8e%87%e7%9a%84%e3%81%aa%e8%a8%ba%e6%96%ad>#</a></h3><p>DOM InvaderはBurpSuiteの機能でDOM XSSのテストや<code>postMessage()</code>の操作を用いたテストの支援を提供します。この機能を用いることでクライアントサイドのPrototype Pollutionの自動検出や手動での検証の補助として利用可能です。</p><p>詳しい検証方法は<a href=https://portswigger.net/burp/documentation/desktop/tools/dom-invader/prototype-pollution>Testing for client-side prototype pollution</a>で丁寧に解説されているので、こちらを参照してください。</p><h2 id=学習方法参考文献>学習方法/参考文献
<a class=anchor href=#%e5%ad%a6%e7%bf%92%e6%96%b9%e6%b3%95%e5%8f%82%e8%80%83%e6%96%87%e7%8c%ae>#</a></h2><ul><li><a href=https://github.com/HoLyVieR/prototype-pollution-nsec18>HoLyVieR/prototype-pollution-nsec18: Content released at NorthSec 2018 for my talk on prototype pollution</a></li><li><a href=https://youtu.be/LUsiFV3dsK8>Olivier Arteau &ndash; Prototype pollution attacks in NodeJS applications - YouTube</a></li><li><a href=https://techblog.securesky-tech.com/entry/2018/10/31/>Node.js における prototype 汚染攻撃への対策 - SST エンジニアブログ</a></li><li><a href="https://www.youtube.com/watch?v=qP8ihBctMeY">【1 分見て】実例から学ぶ prototype pollution【kurenaif 勉強日記】 - YouTube</a></li><li><a href=https://portswigger.net/daily-swig/prototype-pollution-the-dangerous-and-underrated-vulnerability-impacting-javascript-applications>Prototype pollution: The dangerous and underrated vulnerability impacting JavaScript applications | The Daily Swig</a></li><li><a href=https://github.com/BlackFan/client-side-prototype-pollution>BlackFan/client-side-prototype-pollution: Prototype Pollution and useful Script Gadgets</a></li><li><a href=https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Global_Objects/Object/proto>Object.prototype.<strong>proto</strong> - JavaScript | MDN</a></li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/WebAppPentestGuidelines/newtechtestdoc/commit/2fd25ef038e57bc9f175af4affa76600a0fe3136 title='最終更新者 Yoshinori Hayashi | March 12, 2023' target=_blank rel=noopener><img src=/newtechtestdoc/svg/calendar.svg class=book-icon alt=Calendar>
<span>March 12, 2023</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#概要>概要</a></li><li><a href=#影響>影響</a></li><li><a href=#原因>原因</a></li><li><a href=#攻撃手法>攻撃手法</a><ul><li><a href=#1-オブジェクトに対してmergeやcloneの操作を行うケース>1. オブジェクトに対してmergeやcloneの操作を行うケース</a></li><li><a href=#2-setvalueobj-key-valueのようにオブジェクトのプロパティを設定するケース>2. <code>setValue(obj, key, value)</code>のようにオブジェクトのプロパティを設定するケース</a></li></ul></li><li><a href=#事例紹介>事例紹介</a></li><li><a href=#対策>対策</a><ul><li><a href=#ライブラリを利用する方法>ライブラリを利用する方法</a></li><li><a href=#objectfreezeを使用する方法><code>Object.freeze</code>を使用する方法</a></li><li><a href=#objectの代わりにmapを使う方法><code>Object</code>の代わりに<code>Map</code>を使う方法</a></li><li><a href=#オブジェクトの作成をobjectcreatenullで行う方法>オブジェクトの作成を<code>Object.create(null)</code>で行う方法</a></li><li><a href=#schema-validation-of-json-input>Schema validation of JSON input</a></li></ul></li><li><a href=#診断方法>診断方法</a><ul><li><a href=#基本的な診断方法>基本的な診断方法</a></li><li><a href=#dom-invaderを用いた効率的な診断>DOM Invaderを用いた効率的な診断</a></li></ul></li><li><a href=#学習方法参考文献>学習方法/参考文献</a></li></ul></nav></div></aside></main></body></html>