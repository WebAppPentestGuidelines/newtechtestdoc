<!doctype html><html lang=ja dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="意図しないサインアップ経路の存在 # 概要 # 管理者画面や会員向けのサービスなどの設計や要件レベルでサインアップ経路を制限しているアプリケーションにおいて、IDaaSの設定不備や誤った利用によって意図しない形でのサインアップが可能になる場合があります。
原因 # 管理者画面や会員向けのサービスなどの設計や要件レベルでのサインアップ経路の例として、管理者以外のユーザによるユーザ作成を想定していないケースが存在します。本稿ではAmazon Cognitoの誤った利用を例に原因について解説します。
$ CLIENT_ID=&#34;xxxxxxxxxxxxxxxxxxxxxxxxxx&#34; $ USER_NAME=&#34;username&#34; $ PASSWORD=&#34;P4ssW0rD&#34; $ ATTRIBUTES=&#34;[]&#34; $ aws cognito-idp sign-up \ --client-id $CLIENT_ID \ --username $USER_NAME \ --password $PASSWORD \ --user-attributes $ATTRIBUTES \ --no-sign-request 誤った利用の例. サインアップに関する不適切な権限の分離
Amazon Cognito User Poolをはじめ、一部のIDaaSではクライアントIDのような識別子を用いて発行されるTokenに権限設定しています。Cognitoではアプリクライアントと呼ばれるクライアントIDを用いてTokenを発行しており、このアプリクライアントに設定される権限をOIDCのScopeとして、JWT形式のトークンを発行します。
このアプリクライアントを一般ユーザと管理者ユーザで分けて利用している場合、属性へのアクセスに関しては制御可能ですが、サインアップに関してはアプリクライアントを介して制御できません。そのため、本来意図したサインアップ経路を制限できないため、第三者がこのアプリクライアントを介して自己サインアップが行えてしまいます。
影響 # 本来であれば閲覧を想定していない第三者が、該当の画面やエンドポイントへのアクセスを行える可能性があります。
対策 # 限定されたサインアップの場合、自己サインアップをはじめとした、利用者が自らユーザを作成できる機能の無効化してください。また、自己サインアップ機能を無効化できない場合、それに準ずる対策が必要となります。
また、管理者による作成に際しては、各IDaaSの提供するAPIへのアクセス方法に準拠し管理者用APIを用いて作成していることを確認してください。
確認リスト # 仕様上、第三者のサインアップを許可していない 第三者のサインアップを許可していない場合 IDaaSの設定で自己サインアップが制御できる 自己サインアップが許可されていない IDaaSの設定で自己サインアップが制御できない 他の機能を用いて認可制御を行える 根本的対策 # 自己サインアップを許可しない設計や要件の場合、根本的対策として該当する機能を無効化し、ユーザによるサインアップを許可しないようにしてください。 無効後に新規作成する際は、RBAC等のアクセス制御を用いて、操作が可能なユーザを限定してください。
自己サインアップを無効化できない場合は、管理者による新規作成フローにおいて、利用者から操作できないカスタム属性などを用いて該当アカウントが管理者作成のアカウントであることを証明する属性を追加し、認可やアクセス制御の際に確認してください。
一時的対策 # 一時的対策として、IDaaSへのIP制限等を行い、管理者利用するIDaaSへの一般ユーザーのアクセスをIPレベルで制限してください。
また、本対策を恒久的な対策とせず、根本的な対策を用いて順次対策してください。
具体: Amazon Cognitoの場合 # Amazon Cognito User Poolにおいては、ユーザーの自己サインアップを無効化する機能が存在するので、この機能を無効化してください。"><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="意図しないサインアップ経路の存在 - IDaaS"><meta property="og:description" content="意図しないサインアップ経路の存在 # 概要 # 管理者画面や会員向けのサービスなどの設計や要件レベルでサインアップ経路を制限しているアプリケーションにおいて、IDaaSの設定不備や誤った利用によって意図しない形でのサインアップが可能になる場合があります。
原因 # 管理者画面や会員向けのサービスなどの設計や要件レベルでのサインアップ経路の例として、管理者以外のユーザによるユーザ作成を想定していないケースが存在します。本稿ではAmazon Cognitoの誤った利用を例に原因について解説します。
$ CLIENT_ID=&#34;xxxxxxxxxxxxxxxxxxxxxxxxxx&#34; $ USER_NAME=&#34;username&#34; $ PASSWORD=&#34;P4ssW0rD&#34; $ ATTRIBUTES=&#34;[]&#34; $ aws cognito-idp sign-up \ --client-id $CLIENT_ID \ --username $USER_NAME \ --password $PASSWORD \ --user-attributes $ATTRIBUTES \ --no-sign-request 誤った利用の例. サインアップに関する不適切な権限の分離
Amazon Cognito User Poolをはじめ、一部のIDaaSではクライアントIDのような識別子を用いて発行されるTokenに権限設定しています。Cognitoではアプリクライアントと呼ばれるクライアントIDを用いてTokenを発行しており、このアプリクライアントに設定される権限をOIDCのScopeとして、JWT形式のトークンを発行します。
このアプリクライアントを一般ユーザと管理者ユーザで分けて利用している場合、属性へのアクセスに関しては制御可能ですが、サインアップに関してはアプリクライアントを介して制御できません。そのため、本来意図したサインアップ経路を制限できないため、第三者がこのアプリクライアントを介して自己サインアップが行えてしまいます。
影響 # 本来であれば閲覧を想定していない第三者が、該当の画面やエンドポイントへのアクセスを行える可能性があります。
対策 # 限定されたサインアップの場合、自己サインアップをはじめとした、利用者が自らユーザを作成できる機能の無効化してください。また、自己サインアップ機能を無効化できない場合、それに準ずる対策が必要となります。
また、管理者による作成に際しては、各IDaaSの提供するAPIへのアクセス方法に準拠し管理者用APIを用いて作成していることを確認してください。
確認リスト # 仕様上、第三者のサインアップを許可していない 第三者のサインアップを許可していない場合 IDaaSの設定で自己サインアップが制御できる 自己サインアップが許可されていない IDaaSの設定で自己サインアップが制御できない 他の機能を用いて認可制御を行える 根本的対策 # 自己サインアップを許可しない設計や要件の場合、根本的対策として該当する機能を無効化し、ユーザによるサインアップを許可しないようにしてください。 無効後に新規作成する際は、RBAC等のアクセス制御を用いて、操作が可能なユーザを限定してください。
自己サインアップを無効化できない場合は、管理者による新規作成フローにおいて、利用者から操作できないカスタム属性などを用いて該当アカウントが管理者作成のアカウントであることを証明する属性を追加し、認可やアクセス制御の際に確認してください。
一時的対策 # 一時的対策として、IDaaSへのIP制限等を行い、管理者利用するIDaaSへの一般ユーザーのアクセスをIPレベルで制限してください。
また、本対策を恒久的な対策とせず、根本的な対策を用いて順次対策してください。
具体: Amazon Cognitoの場合 # Amazon Cognito User Poolにおいては、ユーザーの自己サインアップを無効化する機能が存在するので、この機能を無効化してください。"><meta property="og:type" content="article"><meta property="og:url" content="https://webapppentestguidelines.github.io/newtechtestdoc/docs/cloudsec/idaas/presence_of_unintended_signup_paths/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2023-03-24T17:07:37+09:00"><title>意図しないサインアップ経路の存在 - IDaaS | WebApp Testing</title>
<link rel=manifest href=/newtechtestdoc/manifest.json><link rel=icon href=/newtechtestdoc/favicon.png type=image/x-icon><link rel=stylesheet href=/newtechtestdoc/book.min.c58292d36b18b675680ab9baea2029204537b839ea72f258746ec0f32ce8d6c8.css integrity="sha256-xYKS02sYtnVoCrm66iApIEU3uDnqcvJYdG7A8yzo1sg=" crossorigin=anonymous><script defer src=/newtechtestdoc/flexsearch.min.js></script><script defer src=/newtechtestdoc/ja.search.min.5a5f26882697f1482eb670388b0798730800d544aebcd385c8846f892c1c23e4.js integrity="sha256-Wl8miCaX8UgutnA4iweYcwgA1USuvNOFyIRviSwcI+Q=" crossorigin=anonymous></script><script defer src=/newtechtestdoc/sw.min.a87e9a69c1c9637cd6edeaed247d3a7735fae81f6bc6668f69a2cc0a283426ec.js integrity="sha256-qH6aacHJY3zW7ertJH06dzX66B9rxmaPaaLMCig0Juw=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/newtechtestdoc/><span>WebApp Testing</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=検索 aria-label=検索 maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/newtechtestdoc/docs/nosql_injection/>NoSQL Injection</a><ul></ul></li><li><a href=/newtechtestdoc/docs/oauth/>OAuth/OpenID Connect</a><ul></ul></li><li><a href=/newtechtestdoc/docs/prototype_pollution/>Prototype Pollution</a><ul></ul></li><li><a href=/newtechtestdoc/docs/toctou/>TOCTOU/レースコンディション</a><ul></ul></li><li><a href=/newtechtestdoc/docs/cloudsec/>クラウドサービスにおけるWebサービスにまつわる脆弱性</a><ul><li><a href=/newtechtestdoc/docs/cloudsec/idaas/>IDaaSの活用に起因する脆弱性とその悪用</a><ul><li><a href=/newtechtestdoc/docs/cloudsec/idaas/edos/>EDoS(Economic Denial of Sustainability) - IDaaS</a></li><li><a href=/newtechtestdoc/docs/cloudsec/idaas/modify_custom_attributes_for_permissions/>アプリケーションの権限に関するカスタム属性の変更 - IDaaS</a></li><li><a href=/newtechtestdoc/docs/cloudsec/idaas/default_error/>デフォルトエラーに起因するユーザーの開示 - IDaaS</a></li><li><a href=/newtechtestdoc/docs/cloudsec/idaas/presence_of_unintended_signup_paths/ class=active>意図しないサインアップ経路の存在 - IDaaS</a></li></ul></li><li><a href=/newtechtestdoc/docs/cloudsec/faas/>FaaSにおける設定不備と脆弱性の悪用</a></li><li><a href=/newtechtestdoc/docs/cloudsec/cloud_credential/>Webアプリケーションの脆弱性を利用した認証情報の窃取</a></li><li><a href=/newtechtestdoc/docs/cloudsec/storage_service/>クラウドストレージサービスにおける設定不備</a></li></ul></li><li><a href=/newtechtestdoc/docs/web_cache_poisoning/>Web Cache Poisoning</a><ul></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/newtechtestdoc/svg/menu.svg class=book-icon alt=Menu>
</label><strong>意図しないサインアップ経路の存在 - IDaaS</strong>
<label for=toc-control><img src=/newtechtestdoc/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#概要>概要</a></li><li><a href=#原因>原因</a></li><li><a href=#影響>影響</a></li><li><a href=#対策>対策</a><ul><li><a href=#確認リスト>確認リスト</a></li><li><a href=#根本的対策>根本的対策</a></li><li><a href=#一時的対策>一時的対策</a></li></ul></li><li><a href=#事例>事例</a></li><li><a href=#学習方法参考文献>学習方法/参考文献</a></li></ul></nav></aside></header><article class=markdown><h1 id=意図しないサインアップ経路の存在>意図しないサインアップ経路の存在
<a class=anchor href=#%e6%84%8f%e5%9b%b3%e3%81%97%e3%81%aa%e3%81%84%e3%82%b5%e3%82%a4%e3%83%b3%e3%82%a2%e3%83%83%e3%83%97%e7%b5%8c%e8%b7%af%e3%81%ae%e5%ad%98%e5%9c%a8>#</a></h1><h2 id=概要>概要
<a class=anchor href=#%e6%a6%82%e8%a6%81>#</a></h2><p>管理者画面や会員向けのサービスなどの設計や要件レベルでサインアップ経路を制限しているアプリケーションにおいて、IDaaSの設定不備や誤った利用によって意図しない形でのサインアップが可能になる場合があります。</p><h2 id=原因>原因
<a class=anchor href=#%e5%8e%9f%e5%9b%a0>#</a></h2><p>管理者画面や会員向けのサービスなどの設計や要件レベルでのサインアップ経路の例として、管理者以外のユーザによるユーザ作成を想定していないケースが存在します。本稿ではAmazon Cognitoの誤った利用を例に原因について解説します。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ CLIENT_ID<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;xxxxxxxxxxxxxxxxxxxxxxxxxx&#34;</span>
</span></span><span style=display:flex><span>$ USER_NAME<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;username&#34;</span>
</span></span><span style=display:flex><span>$ PASSWORD<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;P4ssW0rD&#34;</span>
</span></span><span style=display:flex><span>$ ATTRIBUTES<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;[]&#34;</span>
</span></span><span style=display:flex><span>$ aws cognito-idp sign-up <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --client-id $CLIENT_ID <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --username $USER_NAME <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --password  $PASSWORD <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --user-attributes $ATTRIBUTES <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>  --no-sign-request
</span></span></code></pre></div><p><strong>誤った利用の例. サインアップに関する不適切な権限の分離</strong></p><p>Amazon Cognito User Poolをはじめ、一部のIDaaSではクライアントIDのような識別子を用いて発行されるTokenに権限設定しています。Cognitoではアプリクライアントと呼ばれるクライアントIDを用いてTokenを発行しており、このアプリクライアントに設定される権限をOIDCのScopeとして、JWT形式のトークンを発行します。</p><p>このアプリクライアントを一般ユーザと管理者ユーザで分けて利用している場合、属性へのアクセスに関しては制御可能ですが、サインアップに関してはアプリクライアントを介して制御できません。そのため、本来意図したサインアップ経路を制限できないため、第三者がこのアプリクライアントを介して自己サインアップが行えてしまいます。</p><h2 id=影響>影響
<a class=anchor href=#%e5%bd%b1%e9%9f%bf>#</a></h2><p>本来であれば閲覧を想定していない第三者が、該当の画面やエンドポイントへのアクセスを行える可能性があります。</p><h2 id=対策>対策
<a class=anchor href=#%e5%af%be%e7%ad%96>#</a></h2><p>限定されたサインアップの場合、自己サインアップをはじめとした、利用者が自らユーザを作成できる機能の無効化してください。また、自己サインアップ機能を無効化できない場合、それに準ずる対策が必要となります。</p><p>また、管理者による作成に際しては、各IDaaSの提供するAPIへのアクセス方法に準拠し管理者用APIを用いて作成していることを確認してください。</p><h3 id=確認リスト>確認リスト
<a class=anchor href=#%e7%a2%ba%e8%aa%8d%e3%83%aa%e3%82%b9%e3%83%88>#</a></h3><ul><li><input disabled type=checkbox> 仕様上、第三者のサインアップを許可していない</li><li>第三者のサインアップを許可していない場合<ul><li>IDaaSの設定で自己サインアップが制御できる<ul><li><input disabled type=checkbox> 自己サインアップが許可されていない</li></ul></li><li>IDaaSの設定で自己サインアップが制御できない<ul><li><input disabled type=checkbox> 他の機能を用いて認可制御を行える</li></ul></li></ul></li></ul><h3 id=根本的対策>根本的対策
<a class=anchor href=#%e6%a0%b9%e6%9c%ac%e7%9a%84%e5%af%be%e7%ad%96>#</a></h3><p>自己サインアップを許可しない設計や要件の場合、根本的対策として該当する機能を無効化し、ユーザによるサインアップを許可しないようにしてください。
無効後に新規作成する際は、RBAC等のアクセス制御を用いて、操作が可能なユーザを限定してください。</p><p>自己サインアップを無効化できない場合は、管理者による新規作成フローにおいて、利用者から操作できないカスタム属性などを用いて該当アカウントが管理者作成のアカウントであることを証明する属性を追加し、認可やアクセス制御の際に確認してください。</p><h3 id=一時的対策>一時的対策
<a class=anchor href=#%e4%b8%80%e6%99%82%e7%9a%84%e5%af%be%e7%ad%96>#</a></h3><p>一時的対策として、IDaaSへのIP制限等を行い、管理者利用するIDaaSへの一般ユーザーのアクセスをIPレベルで制限してください。</p><p>また、本対策を恒久的な対策とせず、根本的な対策を用いて順次対策してください。</p><h4 id=具体-amazon-cognitoの場合>具体: Amazon Cognitoの場合
<a class=anchor href=#%e5%85%b7%e4%bd%93-amazon-cognito%e3%81%ae%e5%a0%b4%e5%90%88>#</a></h4><p>Amazon Cognito User Poolにおいては、ユーザーの自己サインアップを無効化する機能が存在するので、この機能を無効化してください。</p><p>管理者用APIへのアクセスに際して、Cognito User PoolのユーザーグループとAmazon Cognito ID Poolを用いて、AWSのCognito User Poolの管理者APIへのアクセスが可能な認証情報を発行してください。この発行される認証情報は最小権限の原則にのっとり、ユーザーグループを用いて管理してください。</p><p>根本的な対策にはなりませんが、管理者が特定のIPからのみ接続する場合は、AWS WAFを用いた接続元IP制限によってCognitoのすべてのAPIへのアクセスを制限するという、一時的な対策も可能です。</p><h4 id=具体-google-identity-platform-の場合>具体: Google Identity Platform の場合
<a class=anchor href=#%e5%85%b7%e4%bd%93-google-identity-platform-%e3%81%ae%e5%a0%b4%e5%90%88>#</a></h4><p>Google Identity Platformにおいては、ユーザーの自己サインアップを無効化する機能が存在するので、この機能を用いて無効化してください。</p><p>また、管理者APIへのアクセスに際しては、Admin SDKを用いたAPIを実装し、それを介してアクセスしてください。</p><h4 id=具体-firebase-authentication-の場合>具体: Firebase Authentication の場合
<a class=anchor href=#%e5%85%b7%e4%bd%93-firebase-authentication-%e3%81%ae%e5%a0%b4%e5%90%88>#</a></h4><p>Firebase Authentication においては、ユーザーの自己サインアップ機能が存在しないため、無効化できません。暫定的な対策として、custom claimによる登録フローに関する属性を追加し、セキュリティルールにおけるバリデーションで不正に作成されたユーザが操作できないよう設定してください。</p><p>また、custom claimに関しては管理者APIへのアクセスが必要なため、Admin SDKを用いたAPIを実装し、それを介してアクセスしてください。</p><h2 id=事例>事例
<a class=anchor href=#%e4%ba%8b%e4%be%8b>#</a></h2><ul><li><a href=https://andresriancho.com/wp-content/uploads/2019/06/whitepaper-internet-scale-analysis-of-aws-cognito-security.pdf>Internet-Scale analysis of AWS Cognito Security</a></li></ul><h2 id=学習方法参考文献>学習方法/参考文献
<a class=anchor href=#%e5%ad%a6%e7%bf%92%e6%96%b9%e6%b3%95%e5%8f%82%e8%80%83%e6%96%87%e7%8c%ae>#</a></h2><ul><li><a href=https://docs.aws.amazon.com/ja_jp/cognito/latest/developerguide/user-pool-settings-admin-create-user-policy.html>Amazon Web Service - Amazon Cognito - 管理者作成ユーザーのポリシーの設定</a></li><li><a href=https://aws.amazon.com/jp/about-aws/whats-new/2022/08/amazon-cognito-enables-native-support-aws-waf/>Amazon Cognito における AWS WAF のネイティブサポートが開始</a></li><li><a href="https://cloud.google.com/identity-platform/docs/concepts-manage-users?hl=ja&_ga=2.183319137.-699514871.1655112464#user-actions">Google Cloud - プロジェクトにおける Identity Platform ユーザー > ユーザーのセルフサービス</a></li><li><a href=https://blog.flatt.tech/entry/firebase_authentication_security>Flatt Security inc. - Firebase Authentication 7つの落とし穴 - 脆弱性を生むIDaaSの不適切な利用</a></li><li><a href=https://blog.flatt.tech/entry/cloud_security_aws_case#341-Cognito-User-Pool>Flatt Security inc. - AWS 診断を事例としたクラウドセキュリティ。サーバーレス環境の不備や見落としがちな Cognito の穴による危険性</a></li><li><a href=https://notsosecure.com/hacking-aws-cognito-misconfigurations>NoSoSecure - Hacking AWS Cognito Misconfigurations</a></li><li><a href=https://erev0s.com/blog/aws-cognito-misconfigurations-in-android-apps/>個人ブログ - AWS Cognito Misconfigurations in Android Apps</a></li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/WebAppPentestGuidelines/newtechtestdoc/commit/d95c8463206e5533a49fc05b90cb19274d70b603 title='最終更新者 kazu1130 | March 24, 2023' target=_blank rel=noopener><img src=/newtechtestdoc/svg/calendar.svg class=book-icon alt=Calendar>
<span>March 24, 2023</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#概要>概要</a></li><li><a href=#原因>原因</a></li><li><a href=#影響>影響</a></li><li><a href=#対策>対策</a><ul><li><a href=#確認リスト>確認リスト</a></li><li><a href=#根本的対策>根本的対策</a></li><li><a href=#一時的対策>一時的対策</a></li></ul></li><li><a href=#事例>事例</a></li><li><a href=#学習方法参考文献>学習方法/参考文献</a></li></ul></nav></div></aside></main></body></html>