<!doctype html><html lang=ja dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="FaaSにおける設定不備と脆弱性の悪用 # 概要 # 本稿では、ウェブやモバイルのアプリケーションで利用されるプログラムの実行を行うサービスである、FaaSの活用と、実装や利用方法が起因となるアプリケーションの脆弱性について解説を行います。
FaaSとは # FaaS(Function as a Service)は、サーバーレスなアプリケーションやマイクロサービスで用いられるサービスで、一定の制約下でプログラムを実行を実行可能にする、IaaSやPaaSのようにクラウド上で利用可能なコンピュータリソースを提供するサービス形態の一つです。
このFaaSは多くのクラウドベンダーで提供されており、私たちは気づかないうちにこれらサービスと向き合っているかもしれません。
AWS Lambda Google Cloud Functions Azure Functions Cloudflare Workers Netlify Functions FaaSの特徴として、あるイベントをトリガーにLambdaにホストされたプログラムが実行されることが挙げられます。下記に簡単な例
例: Amazon Web Service Japan 形で考えるサーバーレス設計より
API Gateway + Lambda + DynamoDBを用いたAPI APIをサーバーレスで構築する際の基本パターンで、API Gatewayへのリクエストをトリガーに実行されます。 S3にアップロード時に画像を加工するためのLambda S3 Bucketに画像やファイルをアップロードしたイベントをトリガーにLambdaを実行するデザインパターンです。 SNS + SQS(Queue) + Lambdaを用いた業務処理 各種重要処理や競合/重複状態を回避するために利用されるデザインパターンで、SNSのPubSub機能を用いて、SQSに投入し、LambdaがそのイベントをもとにQueueに入ったデータを取得し実行されます。 脆弱性 / 脅威 / 悪用 # 本稿では、FaaSの利用や設定ミスによって発生するセキュリティ上の脅威や悪用について、下記のページにて触れていきます。また、Injectionやエラー情報の開示といった「アプリケーションの実装」に起因するものは個別には取り扱いませんのでご了承ください。
概要 # 多くのクラウドプロバイダーの提供するFaaSでは、プログラムを実行する際に用いる環境変数設定できる機能が存在します。これら環境変数機能を用いることで、FaaS上で動作するアプリケーション等に値を渡すことが可能です。 この機能では基本的にAPIキーやDBの認証情報、IAMの認証情報などの機密性の高い情報を格納することを非推奨の項目としています。しかし、この環境変数内に認証情報を格納することは禁止されているわけではないため、利用者の実装次第ではこれら情報が含まれている可能性が存在します。 このように環境変数を用いることは、直接的な攻撃につながるわけではありませんが潜在的に認証情報が取得される可能性を高めている状況にあります。
原理 # FaaSの環境変数に格納された認証情報は、/proc/self/environ等から読み取ることが可能で、アプリケーション上の実装の不備をつくことで、入手される可能性があります。
擬似環境での解説 # 例として、AWS Lambda(AWSの提供するFaaS)上で動作する擬似的な環境をもとに解説をします。
擬似環境の構成図 このAWS Lambdaには、環境変数にSECRET_KEYという環境変数が設定されており、その値にはSECRET_DUMMYという値が設定されています。そして、動作するコードとして下記のようなJavaScriptのコードが動いています。 このアプリケーションはざっくりな機能として、S3からファイルを取得し、その後Lambda内で加工してクライアントに返すという機能を持っています。 app."><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="FaaSにおける設定不備と脆弱性の悪用"><meta property="og:description" content="FaaSにおける設定不備と脆弱性の悪用 # 概要 # 本稿では、ウェブやモバイルのアプリケーションで利用されるプログラムの実行を行うサービスである、FaaSの活用と、実装や利用方法が起因となるアプリケーションの脆弱性について解説を行います。
FaaSとは # FaaS(Function as a Service)は、サーバーレスなアプリケーションやマイクロサービスで用いられるサービスで、一定の制約下でプログラムを実行を実行可能にする、IaaSやPaaSのようにクラウド上で利用可能なコンピュータリソースを提供するサービス形態の一つです。
このFaaSは多くのクラウドベンダーで提供されており、私たちは気づかないうちにこれらサービスと向き合っているかもしれません。
AWS Lambda Google Cloud Functions Azure Functions Cloudflare Workers Netlify Functions FaaSの特徴として、あるイベントをトリガーにLambdaにホストされたプログラムが実行されることが挙げられます。下記に簡単な例
例: Amazon Web Service Japan 形で考えるサーバーレス設計より
API Gateway + Lambda + DynamoDBを用いたAPI APIをサーバーレスで構築する際の基本パターンで、API Gatewayへのリクエストをトリガーに実行されます。 S3にアップロード時に画像を加工するためのLambda S3 Bucketに画像やファイルをアップロードしたイベントをトリガーにLambdaを実行するデザインパターンです。 SNS + SQS(Queue) + Lambdaを用いた業務処理 各種重要処理や競合/重複状態を回避するために利用されるデザインパターンで、SNSのPubSub機能を用いて、SQSに投入し、LambdaがそのイベントをもとにQueueに入ったデータを取得し実行されます。 脆弱性 / 脅威 / 悪用 # 本稿では、FaaSの利用や設定ミスによって発生するセキュリティ上の脅威や悪用について、下記のページにて触れていきます。また、Injectionやエラー情報の開示といった「アプリケーションの実装」に起因するものは個別には取り扱いませんのでご了承ください。
概要 # 多くのクラウドプロバイダーの提供するFaaSでは、プログラムを実行する際に用いる環境変数設定できる機能が存在します。これら環境変数機能を用いることで、FaaS上で動作するアプリケーション等に値を渡すことが可能です。 この機能では基本的にAPIキーやDBの認証情報、IAMの認証情報などの機密性の高い情報を格納することを非推奨の項目としています。しかし、この環境変数内に認証情報を格納することは禁止されているわけではないため、利用者の実装次第ではこれら情報が含まれている可能性が存在します。 このように環境変数を用いることは、直接的な攻撃につながるわけではありませんが潜在的に認証情報が取得される可能性を高めている状況にあります。
原理 # FaaSの環境変数に格納された認証情報は、/proc/self/environ等から読み取ることが可能で、アプリケーション上の実装の不備をつくことで、入手される可能性があります。
擬似環境での解説 # 例として、AWS Lambda(AWSの提供するFaaS)上で動作する擬似的な環境をもとに解説をします。
擬似環境の構成図 このAWS Lambdaには、環境変数にSECRET_KEYという環境変数が設定されており、その値にはSECRET_DUMMYという値が設定されています。そして、動作するコードとして下記のようなJavaScriptのコードが動いています。 このアプリケーションはざっくりな機能として、S3からファイルを取得し、その後Lambda内で加工してクライアントに返すという機能を持っています。 app."><meta property="og:type" content="article"><meta property="og:url" content="https://webapppentestguidelines.github.io/newtechtestdoc/docs/cloudsec/faas/"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2023-02-28T20:09:08+09:00"><title>FaaSにおける設定不備と脆弱性の悪用 | WebApp Testing</title><link rel=manifest href=/newtechtestdoc/manifest.json><link rel=icon href=/newtechtestdoc/favicon.png type=image/x-icon><link rel=stylesheet href=/newtechtestdoc/book.min.c58292d36b18b675680ab9baea2029204537b839ea72f258746ec0f32ce8d6c8.css integrity="sha256-xYKS02sYtnVoCrm66iApIEU3uDnqcvJYdG7A8yzo1sg=" crossorigin=anonymous><script defer src=/newtechtestdoc/flexsearch.min.js></script>
<script defer src=/newtechtestdoc/ja.search.min.b98c344b6de4f608bc6fd812551cc61370279d34ecd10f070a20509ef8ca8e18.js integrity="sha256-uYw0S23k9gi8b9gSVRzGE3AnnTTs0Q8HCiBQnvjKjhg=" crossorigin=anonymous></script>
<script defer src=/newtechtestdoc/sw.min.a87e9a69c1c9637cd6edeaed247d3a7735fae81f6bc6668f69a2cc0a283426ec.js integrity="sha256-qH6aacHJY3zW7ertJH06dzX66B9rxmaPaaLMCig0Juw=" crossorigin=anonymous></script></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/newtechtestdoc/><span>WebApp Testing</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=検索 aria-label=検索 maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/newtechtestdoc/docs/nosql_injection/>NoSQL Injection</a><ul></ul></li><li><a href=/newtechtestdoc/docs/oauth/>OAuth/OpenID Connect</a><ul></ul></li><li><a href=/newtechtestdoc/docs/prototype_pollution/>Prototype Pollution</a><ul></ul></li><li><a href=/newtechtestdoc/docs/toctou/>TOCTOU/レースコンディション</a><ul></ul></li><li><a href=/newtechtestdoc/docs/cloudsec/>クラウドサービスにおけるWebサービスにまつわる脆弱性</a><ul><li><a href=/newtechtestdoc/docs/cloudsec/idaas/>IDaaSの活用に起因する脆弱性とその悪用</a><ul><li><a href=/newtechtestdoc/docs/cloudsec/idaas/edos/>EDoS(Economic Denial of Sustainability) - IDaaS</a></li><li><a href=/newtechtestdoc/docs/cloudsec/idaas/modify_custom_attributes_for_permissions/>アプリケーションの権限に関するカスタム属性の変更 - IDaaS</a></li><li><a href=/newtechtestdoc/docs/cloudsec/idaas/default_error/>デフォルトエラーに起因するユーザーの開示 - IDaaS</a></li><li><a href=/newtechtestdoc/docs/cloudsec/idaas/presence_of_unintended_signup_paths/>意図しないサインアップ経路の存在 - IDaaS</a></li></ul></li><li><a href=/newtechtestdoc/docs/cloudsec/faas/ class=active>FaaSにおける設定不備と脆弱性の悪用</a></li><li><a href=/newtechtestdoc/docs/cloudsec/cloud_credential/>Webアプリケーションの脆弱性を利用した認証情報の窃取</a></li><li><a href=/newtechtestdoc/docs/cloudsec/storage_service/>クラウドストレージサービスにおける設定不備</a></li></ul></li><li><a href=/newtechtestdoc/docs/web_cache_poisoning/>Web Cache Poisoning</a><ul></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/newtechtestdoc/svg/menu.svg class=book-icon alt=Menu></label>
<strong>FaaSにおける設定不備と脆弱性の悪用</strong>
<label for=toc-control><img src=/newtechtestdoc/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#概要>概要</a></li><li><a href=#faasとは>FaaSとは</a></li></ul><ul><li><a href=#概要-1>概要</a></li><li><a href=#原理>原理</a><ul><li><a href=#擬似環境での解説>擬似環境での解説</a></li></ul></li><li><a href=#観点>観点</a></li><li><a href=#影響>影響</a></li><li><a href=#対策>対策</a></li><li><a href=#学習方法参考文献>学習方法/参考文献</a></li></ul></nav></aside></header><article class=markdown><h1 id=faasにおける設定不備と脆弱性の悪用>FaaSにおける設定不備と脆弱性の悪用
<a class=anchor href=#faas%e3%81%ab%e3%81%8a%e3%81%91%e3%82%8b%e8%a8%ad%e5%ae%9a%e4%b8%8d%e5%82%99%e3%81%a8%e8%84%86%e5%bc%b1%e6%80%a7%e3%81%ae%e6%82%aa%e7%94%a8>#</a></h1><h2 id=概要>概要
<a class=anchor href=#%e6%a6%82%e8%a6%81>#</a></h2><p>本稿では、ウェブやモバイルのアプリケーションで利用されるプログラムの実行を行うサービスである、FaaSの活用と、実装や利用方法が起因となるアプリケーションの脆弱性について解説を行います。</p><h2 id=faasとは>FaaSとは
<a class=anchor href=#faas%e3%81%a8%e3%81%af>#</a></h2><p>FaaS(Function as a Service)は、サーバーレスなアプリケーションやマイクロサービスで用いられるサービスで、一定の制約下でプログラムを実行を実行可能にする、IaaSやPaaSのようにクラウド上で利用可能なコンピュータリソースを提供するサービス形態の一つです。</p><p>このFaaSは多くのクラウドベンダーで提供されており、私たちは気づかないうちにこれらサービスと向き合っているかもしれません。</p><ul><li><a href=https://aws.amazon.com/jp/lambda/>AWS Lambda</a></li><li><a href="https://cloud.google.com/functions?hl=ja">Google Cloud Functions</a></li><li><a href=https://azure.microsoft.com/ja-jp/products/functions/>Azure Functions</a></li><li><a href=https://www.cloudflare.com/ja-jp/products/workers/>Cloudflare Workers</a></li><li><a href=https://www.netlify.com/products/functions/>Netlify Functions</a></li></ul><p>FaaSの特徴として、あるイベントをトリガーにLambdaにホストされたプログラムが実行されることが挙げられます。下記に簡単な例</p><p>例: Amazon Web Service Japan <a href=https://aws.amazon.com/jp/serverless/patterns/serverless-pattern/>形で考えるサーバーレス設計</a>より</p><p><strong>API Gateway + Lambda + DynamoDBを用いたAPI</strong>
APIをサーバーレスで構築する際の基本パターンで、API Gatewayへのリクエストをトリガーに実行されます。
<img src=../image/Pattern-DynamicWeb.3ba6461f647c5156223f5b6710f151c7c542a67a.png alt="動的 Web / モバイルバックエンドの図"></p><p><strong>S3にアップロード時に画像を加工するためのLambda</strong>
S3 Bucketに画像やファイルをアップロードしたイベントをトリガーにLambdaを実行するデザインパターンです。
<img src=../image/Pattern-S3-processing.0a24e9465dec531156f56ce1c961d00a8e529f3a.png alt="画像処理 / シンプルなデータ加工の図"></p><p><strong>SNS + SQS(Queue) + Lambdaを用いた業務処理</strong>
各種重要処理や競合/重複状態を回避するために利用されるデザインパターンで、SNSのPubSub機能を用いて、SQSに投入し、LambdaがそのイベントをもとにQueueに入ったデータを取得し実行されます。
<img src=../image/Pattern-Integration.77b207fd045bc2283fe06cb76dc934764ca7114a.png alt=イベント駆動の業務処理連携の図></p><h1 id=脆弱性--脅威--悪用>脆弱性 / 脅威 / 悪用
<a class=anchor href=#%e8%84%86%e5%bc%b1%e6%80%a7--%e8%84%85%e5%a8%81--%e6%82%aa%e7%94%a8>#</a></h1><p>本稿では、FaaSの利用や設定ミスによって発生するセキュリティ上の脅威や悪用について、下記のページにて触れていきます。また、Injectionやエラー情報の開示といった「アプリケーションの実装」に起因するものは個別には取り扱いませんのでご了承ください。</p><h2 id=概要-1>概要
<a class=anchor href=#%e6%a6%82%e8%a6%81-1>#</a></h2><p>多くのクラウドプロバイダーの提供するFaaSでは、プログラムを実行する際に用いる環境変数設定できる機能が存在します。これら環境変数機能を用いることで、FaaS上で動作するアプリケーション等に値を渡すことが可能です。
この機能では基本的にAPIキーやDBの認証情報、IAMの認証情報などの機密性の高い情報を格納することを非推奨の項目としています。しかし、この環境変数内に認証情報を格納することは禁止されているわけではないため、利用者の実装次第ではこれら情報が含まれている可能性が存在します。
このように環境変数を用いることは、直接的な攻撃につながるわけではありませんが潜在的に認証情報が取得される可能性を高めている状況にあります。</p><h2 id=原理>原理
<a class=anchor href=#%e5%8e%9f%e7%90%86>#</a></h2><p>FaaSの環境変数に格納された認証情報は、<code>/proc/self/environ</code>等から読み取ることが可能で、アプリケーション上の実装の不備をつくことで、入手される可能性があります。</p><h3 id=擬似環境での解説>擬似環境での解説
<a class=anchor href=#%e6%93%ac%e4%bc%bc%e7%92%b0%e5%a2%83%e3%81%a7%e3%81%ae%e8%a7%a3%e8%aa%ac>#</a></h3><p>例として、AWS Lambda(AWSの提供するFaaS)上で動作する擬似的な環境をもとに解説をします。</p><p><strong>擬似環境の構成図</strong>
<img src=../image/Pasted-image-20230221233149.png alt></p><p>このAWS Lambdaには、環境変数に<code>SECRET_KEY</code>という環境変数が設定されており、その値には<code>SECRET_DUMMY</code>という値が設定されています。そして、動作するコードとして下記のようなJavaScriptのコードが動いています。
このアプリケーションはざっくりな機能として、S3からファイルを取得し、その後Lambda内で加工してクライアントに返すという機能を持っています。
<strong>app.js</strong></p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>fs</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;fs&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>AWS</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;aws-sdk&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>exports</span>.<span style=color:#a6e22e>handler</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>async</span> (<span style=color:#a6e22e>event</span>) =&gt; {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>file</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>event</span>.<span style=color:#a6e22e>queryStringParameters</span>.<span style=color:#a6e22e>file</span>;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>s3</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>AWS</span>.<span style=color:#a6e22e>S3</span>();
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>params</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Bucket</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;dummy_bucket_name&#39;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Key</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>file</span>
</span></span><span style=display:flex><span>        };
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>s3_file</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>await</span> <span style=color:#a6e22e>s3</span>.<span style=color:#a6e22e>getObject</span>(<span style=color:#a6e22e>params</span>).<span style=color:#a6e22e>promise</span>();
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>writeFileSync</span>(<span style=color:#e6db74>`/tmp/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>file</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, <span style=color:#a6e22e>s3_file</span>.<span style=color:#a6e22e>Body</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>catch</span> (<span style=color:#a6e22e>err</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>err</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>/**
</span></span></span><span style=display:flex><span><span style=color:#75715e>     * ~~画像やファイル操作等の諸々の処理~~
</span></span></span><span style=display:flex><span><span style=color:#75715e>     */</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>env_file_data</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>readFileSync</span>(<span style=color:#e6db74>`/tmp/</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>file</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>, <span style=color:#e6db74>&#39;utf8&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>response</span> <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>statusCode</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>200</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>body</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>env_file_data</span>
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>response</span>;
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>上記のアプリケーションでは、API Gatewayからイベントとして送られてきた、queryStringParametersを直接readFileSyncに利用しており、Path Traversal攻撃が発生する状況にあります。
そのため、<code>"../../../../proc/self/environ"</code>と値を入力すると、実装上意図しないローカルファイルが取得できてしまう状況にあります。</p><p>そして、実際に攻撃を受けた際は下記のようなレスポンスが帰ってきます。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;statusCode&#34;</span>: <span style=color:#ae81ff>200</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;body&#34;</span>: <span style=color:#e6db74>&#34;AWS_LAMBDA_FUNCTION_VERSION=$LATEST\u0000AWS_SESSION_TOKEN=...\u0000LD_LIBRARY_PATH=/var/lang/lib:/lib64:/usr/lib64:/var/runtime:/var/runtime/lib:/var/task:/var/task/lib:/opt/lib\u0000AWS_LAMBDA_LOG_GROUP_NAME=/aws/lambda/vulnfunc\u0000LAMBDA_TASK_ROOT=/var/task\u0000AWS_LAMBDA_LOG_STREAM_NAME=2023/02/21/[$LATEST]97a22f53be874c9db31c5ee126df276e\u0000AWS_LAMBDA_RUNTIME_API=127.0.0.1:9001\u0000AWS_EXECUTION_ENV=AWS_Lambda_nodejs14.x\u0000AWS_LAMBDA_FUNCTION_NAME=vulnfunc\u0000AWS_XRAY_DAEMON_ADDRESS=169.254.79.129:2000\u0000PATH=/var/lang/bin:/usr/local/bin:/usr/bin/:/bin:/opt/bin\u0000AWS_DEFAULT_REGION=ap-northeast-1\u0000SECRET_KEY=SECRET_DUMMY\u0000PWD=/var/task\u0000AWS_SECRET_ACCESS_KEY=...\u0000LAMBDA_RUNTIME_DIR=/var/runtime\u0000LANG=en_US.UTF-8\u0000AWS_LAMBDA_INITIALIZATION_TYPE=on-demand\u0000NODE_PATH=/opt/nodejs/node14/node_modules:/opt/nodejs/node_modules:/var/runtime/node_modules:/var/runtime:/var/task\u0000AWS_REGION=ap-northeast-1\u0000TZ=:UTC\u0000AWS_ACCESS_KEY_ID=....\u0000SHLVL=0\u0000_AWS_XRAY_DAEMON_ADDRESS=....\u0000_AWS_XRAY_DAEMON_PORT=2000\u0000_LAMBDA_TELEMETRY_LOG_FD=3\u0000AWS_XRAY_CONTEXT_MISSING=LOG_ERROR\u0000_HANDLER=index.handler\u0000AWS_LAMBDA_FUNCTION_MEMORY_SIZE=128\u0000NODE_EXTRA_CA_CERTS=/etc/pki/tls/certs/ca-bundle.crt\u0000&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>出力された環境変数を整形すると下記のようになります。環境変数内には先に環境変数に設定した<code>SECRET_KEY</code>が含まれており、攻撃者に認証情報が取得されてしまったことがわかります。</p><pre tabindex=0><code>AWS_LAMBDA_FUNCTION_VERSION=$LATEST
AWS_SESSION_TOKEN=...
LD_LIBRARY_PATH=/var/lang/lib:/lib64:/usr/lib64:/var/runtime:/var/runtime/lib:/var/task:/var/task/lib:/opt/lib
AWS_LAMBDA_LOG_GROUP_NAME=/aws/lambda/vulnfunc
LAMBDA_TASK_ROOT=/var/task
AWS_LAMBDA_LOG_STREAM_NAME=2023/02/21/[$LATEST]97a22f53be874c9db31c5ee126df276e
AWS_LAMBDA_RUNTIME_API=127.0.0.1:9001
AWS_EXECUTION_ENV=AWS_Lambda_nodejs14.x
AWS_LAMBDA_FUNCTION_NAME=vulnfunc
AWS_XRAY_DAEMON_ADDRESS=169.254.79.129:2000
PATH=/var/lang/bin:/usr/local/bin:/usr/bin/:/bin:/opt/bin
AWS_DEFAULT_REGION=ap-northeast-1
SECRET_KEY=SECRET_DUMMY
PWD=/var/task
AWS_SECRET_ACCESS_KEY=...
AWS_REGION=ap-northeast-1
TZ=:UTC
AWS_ACCESS_KEY_ID=....
SHLVL=0
_LAMBDA_TELEMETRY_LOG_FD=3
AWS_XRAY_CONTEXT_MISSING=LOG_ERROR
_HANDLER=index.handler
NODE_EXTRA_CA_CERTS=/etc/pki/tls/certs/ca-bundle.crt
</code></pre><h2 id=観点>観点
<a class=anchor href=#%e8%a6%b3%e7%82%b9>#</a></h2><p>もしIAMを顧客から貰えている場合は、FaaSの環境変数に認証情報が含まれていないことを確認してください。また、ブラックボックスでの検証が必要な場合は、下記のいずれかの脆弱性を有している場合、FaaSに設定された認証情報を取得することが可能な場合があるので、確認をしてください。</p><ul><li>Injection攻撃: 主にOSコマンドやサーバーサイドテンプレート等のFaaS上で任意のコマンドやコードが実行可能なInjection攻撃が存在する場合、アプリケーションその物や、その先にFaaSがいる可能性を考慮して診断を行ってください</li><li>任意のファイルを読み取ることの可能な攻撃: LFI等のPathに関わる攻撃が存在する場合、アプリケーションその物や、その先にFaaSがいる可能性を考慮して診断を行ってください</li></ul><h2 id=影響>影響
<a class=anchor href=#%e5%bd%b1%e9%9f%bf>#</a></h2><p>認証情報が漏洩し、攻撃者等に悪用される可能性があります。</p><h2 id=対策>対策
<a class=anchor href=#%e5%af%be%e7%ad%96>#</a></h2><p>FaaSで動作するアプリケーションの実装時も、通常のアプリケーション同様の脆弱性対策を行う必要があります。
また、クラウドがFaaSに付与しているIAMの認証情報に関しては、FaaSの特性上、環境変数からアクセスを行うため完全な保護は難しい状況にあります。そのため、漏洩した場合のリスクを最小化するために、付与する権限は最小限化したうえで、操作元をそのFaaSのみに設定してください。</p><h2 id=学習方法参考文献>学習方法/参考文献
<a class=anchor href=#%e5%ad%a6%e7%bf%92%e6%96%b9%e6%b3%95%e5%8f%82%e8%80%83%e6%96%87%e7%8c%ae>#</a></h2><ul><li><a href=https://docs.aws.amazon.com/ja_jp/lambda/latest/dg/configuration-envvars.html>AWS Lambda 環境変数の使用</a></li><li><a href=https://blog.flatt.tech/entry/lambda_secret_security>AWS Lambdaで秘密情報をセキュアに扱う - アンチパターンとTerraformも用いた推奨例の解説</a></li><li><a href="https://cloud.google.com/functions/docs/configuring/env-var?hl=ja">Google Cloud Functionsの環境変数</a></li><li><a href=https://developers.cloudflare.com/workers/platform/environment-variables/>Cloudflere Workersの環境変数</a></li><li><a href=https://developers.cloudflare.com/workers/platform/environment-variables/#add-secrets-to-your-project>Cloudflere Workersのシークレットの取り扱い</a></li><li><a href=https://owasp.org/www-project-serverless-top-10/>OWASP Serverless Top 10</a></li><li><a href=https://unit42.paloaltonetworks.com/compromised-cloud-compute-credentials/>Compromised Cloud Compute Credentials: Case Studies From the Wild</a></li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/WebAppPentestGuidelines/newtechtestdoc/commit/d0a4dd68dabf3af7788c681cbab99809d95df9d3 title='最終更新者 a-zara-n | February 28, 2023' target=_blank rel=noopener><img src=/newtechtestdoc/svg/calendar.svg class=book-icon alt=Calendar>
<span>February 28, 2023</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#概要>概要</a></li><li><a href=#faasとは>FaaSとは</a></li></ul><ul><li><a href=#概要-1>概要</a></li><li><a href=#原理>原理</a><ul><li><a href=#擬似環境での解説>擬似環境での解説</a></li></ul></li><li><a href=#観点>観点</a></li><li><a href=#影響>影響</a></li><li><a href=#対策>対策</a></li><li><a href=#学習方法参考文献>学習方法/参考文献</a></li></ul></nav></div></aside></main></body></html>