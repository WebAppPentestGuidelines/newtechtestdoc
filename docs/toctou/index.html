<!doctype html><html lang=ja dir=ltr><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="TOCTOU/レースコンディション # 概要 # システム開発のセキュリティにおいてレースコンディションと TOCTOU は、しばしば混同して使われることがありますが、それぞれの違いについて用語の整理から確認していきましょう。
レースコンディション(Race Condition)とは、複数の処理が同じデータに対してアクセスしたときに、競合状態になることで想定外の処理が引き起こされる問題です。
対して TOCTOU(Time Of Check To Time Of Use)とは、あるデータの検証時点と使用時点での状態の差異によって想定外の処理が引き起こされる問題です。
つまりレースコンディションは、さまざまな競合状態の問題を表す包括的な脆弱性なのに対し、TOCTOU はより実装の状況を限定した具体的な脆弱性であることが分かります。
本章では、主に TOCTOU に関連する脆弱性や攻撃手法について説明します。
原因 # TOCTOU は主にデータの検証と使用のタイミングが異なっていることに起因しています。
そのため、TOCTOU を対策する考え方としては、データのチェックと使用を同時に行い、処理の差を発生させないようにすることが理想的です。
影響 # 代表的な影響の例として、許可されていないデータへのアクセスやある操作の回数制限を超えた実行などが考えられます。 しかしながら、データの内容や重要性、アプリケーションの振る舞いといったビジネスロジックによって TOCTOU による影響範囲は大きく異なります。
ここでは TOCTOU が発生しやすい機能を例にあげます。
送金処理 クーポンやキャンペーンコード等の発行や使用 アカウントの新規登録 「高評価」や「いいね」などの投票機能 診断観点/攻撃手法 # 一般的に、DAST のようなツールを使用して TOCTOU の脆弱性を特定することは困難です。
これは、競合状態を引き起こした状態と正常な Web アプリケーションの振る舞いの違いを機械的に判断することは難しいためです。
また、TOCTOU の診断はミリ秒単位で調整されたリクエスト送信や単一の HTTP パイプライン内で複数の HTTP リクエストを送る診断が必要になります。そのため、Web アプリケーション診断に特化した専門ツール(Burp Suite など)が必要になります。
このように、競合状態を起こすための条件や環境を整える必要がある性質上、ほかの Web アプリケーション脆弱性診断に比べて手動によるテストの難易度が高いと考えられています。
具体的には、実行回数に制限があるような機能や重複防止の制限が設けられている機能などで TOCTOU の診断が有用です。
Burp Intruder を使用した診断 # Burp に搭載されている機能の 1 つである Burp Intruder を使用して TOCTOU の診断を確認するパターンを紹介します。 なお、 Community Edition には機能制限があるため Pro Edition でしか診断できません。 Community Edition を使用する場合は、後述する Turbo Intruder を使用した診断方法をご覧ください。"><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="TOCTOU/レースコンディション"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="https://webapppentestguidelines.github.io/newtechtestdoc/docs/toctou/"><title>TOCTOU/レースコンディション | WebApp Testing</title>
<link rel=manifest href=/newtechtestdoc/manifest.json><link rel=icon href=/newtechtestdoc/favicon.png type=image/x-icon><link rel=stylesheet href=/newtechtestdoc/book.min.c58292d36b18b675680ab9baea2029204537b839ea72f258746ec0f32ce8d6c8.css integrity="sha256-xYKS02sYtnVoCrm66iApIEU3uDnqcvJYdG7A8yzo1sg=" crossorigin=anonymous><script defer src=/newtechtestdoc/flexsearch.min.js></script><script defer src=/newtechtestdoc/ja.search.min.5a5f26882697f1482eb670388b0798730800d544aebcd385c8846f892c1c23e4.js integrity="sha256-Wl8miCaX8UgutnA4iweYcwgA1USuvNOFyIRviSwcI+Q=" crossorigin=anonymous></script><script defer src=/newtechtestdoc/sw.min.a87e9a69c1c9637cd6edeaed247d3a7735fae81f6bc6668f69a2cc0a283426ec.js integrity="sha256-qH6aacHJY3zW7ertJH06dzX66B9rxmaPaaLMCig0Juw=" crossorigin=anonymous></script><link rel=alternate type=application/rss+xml href=https://webapppentestguidelines.github.io/newtechtestdoc/docs/toctou/index.xml title="WebApp Testing"></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/newtechtestdoc/><span>WebApp Testing</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=検索 aria-label=検索 maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/newtechtestdoc/docs/nosql_injection/>NoSQL Injection</a><ul></ul></li><li><a href=/newtechtestdoc/docs/oauth/>OAuth/OpenID Connect</a><ul></ul></li><li><a href=/newtechtestdoc/docs/prototype_pollution/>Prototype Pollution</a><ul></ul></li><li><a href=/newtechtestdoc/docs/toctou/ class=active>TOCTOU/レースコンディション</a><ul></ul></li><li><a href=/newtechtestdoc/docs/cloudsec/>クラウドサービスにおけるWebサービスにまつわる脆弱性</a><ul><li><a href=/newtechtestdoc/docs/cloudsec/idaas/>IDaaSの活用に起因する脆弱性とその悪用</a><ul><li><a href=/newtechtestdoc/docs/cloudsec/idaas/edos/>EDoS(Economic Denial of Sustainability) - IDaaS</a></li><li><a href=/newtechtestdoc/docs/cloudsec/idaas/modify_custom_attributes_for_permissions/>アプリケーションの権限に関するカスタム属性の変更 - IDaaS</a></li><li><a href=/newtechtestdoc/docs/cloudsec/idaas/default_error/>デフォルトエラーに起因するユーザーの開示 - IDaaS</a></li><li><a href=/newtechtestdoc/docs/cloudsec/idaas/presence_of_unintended_signup_paths/>意図しないサインアップ経路の存在 - IDaaS</a></li></ul></li><li><a href=/newtechtestdoc/docs/cloudsec/faas/>FaaSにおける設定不備と脆弱性の悪用</a></li><li><a href=/newtechtestdoc/docs/cloudsec/cloud_credential/>Webアプリケーションの脆弱性を利用した認証情報の窃取</a></li><li><a href=/newtechtestdoc/docs/cloudsec/storage_service/>クラウドストレージサービスにおける設定不備</a></li></ul></li><li><a href=/newtechtestdoc/docs/web_cache_poisoning/>Web Cache Poisoning</a><ul></ul></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/newtechtestdoc/svg/menu.svg class=book-icon alt=Menu>
</label><strong>TOCTOU/レースコンディション</strong>
<label for=toc-control><img src=/newtechtestdoc/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#概要>概要</a></li><li><a href=#原因>原因</a></li><li><a href=#影響>影響</a></li><li><a href=#診断観点攻撃手法>診断観点/攻撃手法</a><ul><li><a href=#burp-intruder-を使用した診断>Burp Intruder を使用した診断</a></li><li><a href=#turbo-intruder-を使用した診断>Turbo Intruder を使用した診断</a></li></ul></li><li><a href=#事例紹介>事例紹介</a></li><li><a href=#対策>対策</a></li><li><a href=#学習方法参考文献>学習方法/参考文献</a></li></ul></nav></aside></header><article class=markdown><h1 id=toctouレースコンディション>TOCTOU/レースコンディション
<a class=anchor href=#toctou%e3%83%ac%e3%83%bc%e3%82%b9%e3%82%b3%e3%83%b3%e3%83%87%e3%82%a3%e3%82%b7%e3%83%a7%e3%83%b3>#</a></h1><h2 id=概要>概要
<a class=anchor href=#%e6%a6%82%e8%a6%81>#</a></h2><p>システム開発のセキュリティにおいてレースコンディションと TOCTOU は、しばしば混同して使われることがありますが、それぞれの違いについて用語の整理から確認していきましょう。</p><p>レースコンディション(Race Condition)とは、複数の処理が同じデータに対してアクセスしたときに、競合状態になることで想定外の処理が引き起こされる問題です。</p><p>対して TOCTOU(Time Of Check To Time Of Use)とは、あるデータの検証時点と使用時点での状態の差異によって想定外の処理が引き起こされる問題です。</p><p>つまりレースコンディションは、さまざまな競合状態の問題を表す包括的な脆弱性なのに対し、TOCTOU はより実装の状況を限定した具体的な脆弱性であることが分かります。</p><p>本章では、主に TOCTOU に関連する脆弱性や攻撃手法について説明します。</p><h2 id=原因>原因
<a class=anchor href=#%e5%8e%9f%e5%9b%a0>#</a></h2><p>TOCTOU は主にデータの検証と使用のタイミングが異なっていることに起因しています。</p><p>そのため、TOCTOU を対策する考え方としては、データのチェックと使用を同時に行い、処理の差を発生させないようにすることが理想的です。</p><h2 id=影響>影響
<a class=anchor href=#%e5%bd%b1%e9%9f%bf>#</a></h2><p>代表的な影響の例として、許可されていないデータへのアクセスやある操作の回数制限を超えた実行などが考えられます。
しかしながら、データの内容や重要性、アプリケーションの振る舞いといったビジネスロジックによって TOCTOU による影響範囲は大きく異なります。</p><p>ここでは TOCTOU が発生しやすい機能を例にあげます。</p><ul><li>送金処理</li><li>クーポンやキャンペーンコード等の発行や使用</li><li>アカウントの新規登録</li><li>「高評価」や「いいね」などの投票機能</li></ul><h2 id=診断観点攻撃手法>診断観点/攻撃手法
<a class=anchor href=#%e8%a8%ba%e6%96%ad%e8%a6%b3%e7%82%b9%e6%94%bb%e6%92%83%e6%89%8b%e6%b3%95>#</a></h2><p>一般的に、DAST のようなツールを使用して TOCTOU の脆弱性を特定することは困難です。</p><p>これは、競合状態を引き起こした状態と正常な Web アプリケーションの振る舞いの違いを機械的に判断することは難しいためです。</p><p>また、TOCTOU の診断はミリ秒単位で調整されたリクエスト送信や単一の HTTP パイプライン内で複数の HTTP リクエストを送る診断が必要になります。そのため、Web アプリケーション診断に特化した専門ツール(Burp Suite など)が必要になります。<br>このように、競合状態を起こすための条件や環境を整える必要がある性質上、ほかの Web アプリケーション脆弱性診断に比べて手動によるテストの難易度が高いと考えられています。</p><p>具体的には、実行回数に制限があるような機能や重複防止の制限が設けられている機能などで TOCTOU の診断が有用です。</p><h3 id=burp-intruder-を使用した診断>Burp Intruder を使用した診断
<a class=anchor href=#burp-intruder-%e3%82%92%e4%bd%bf%e7%94%a8%e3%81%97%e3%81%9f%e8%a8%ba%e6%96%ad>#</a></h3><p>Burp に搭載されている機能の 1 つである Burp Intruder を使用して TOCTOU の診断を確認するパターンを紹介します。
なお、 Community Edition には機能制限があるため Pro Edition でしか診断できません。
Community Edition を使用する場合は、後述する Turbo Intruder を使用した診断方法をご覧ください。</p><p>始めに、送信したいリクエストを Burp Intruder にセットします。</p><p>Burp Intruder を開始するにはペイロードポジションを設定する必要がありますが、ペイロードによる作用を防ぎたいです。
そのため、ダミー用のリクエストヘッダ(<code>x-dummy</code>)を用意し、ダミー用ヘッダの値にペイロードポジションを設定します。</p><p><img src=./toctou_image1.png alt=toctou_image1></p><p>次に、ペイロードを設定します。</p><p><code>Payload Type</code>を<code>Null payloads</code>に設定します。</p><p>Generate の空白欄に送信したいリクエスト数を入力します。</p><p><img src="./toctou_image2.png?width=50pc" alt=toctou_image2></p><p>デフォルトでは同時に 10 リクエストを送信します。</p><p>より多くのリクエストを送信したい場合は、<code>Resource Pool</code>設定から新しいリソースプール設定を作成し、<code>Maximum concurrent requests</code>を設定してください。</p><p><img src=./toctou_image3.png alt=toctou_image3></p><h3 id=turbo-intruder-を使用した診断>Turbo Intruder を使用した診断
<a class=anchor href=#turbo-intruder-%e3%82%92%e4%bd%bf%e7%94%a8%e3%81%97%e3%81%9f%e8%a8%ba%e6%96%ad>#</a></h3><p>Burp Suite の拡張機能として公開されている Trubo Intruder を使用したパターンを紹介します。</p><p>Turbo Intruder は、大量の HTTP リクエストを送信したり、Python を使用して柔軟にリクエスト前後の処理を操作できる拡張機能です。</p><p>また、Turbo Intruder は、標準の Burp Intruder とは異なり Community Edition でも使用できます。</p><blockquote class="book-hint info"><strong>注意</strong><br>Turbo Intruder は、Port Swigger 社のセキュリティリサーチャーである James Kettle 氏によって開発されています。しかし、十分なテストが行われていないため Burp の標準機能よりも信頼性がなく、システムパフォーマンスに影響を及ぼす可能性があるため、自己責任のもと拡張機能を使用してください。</blockquote><p>送信したいリクエストを選択し、コンテキストメニューから<code>Extensions</code>-><code>Turbo Intruder</code>-><code>Send to turbo intruder</code>をクリックして、Turbo Intruder へリクエストを送ります。</p><p><img src=./toctou_image4.png alt=toctou_image4></p><p>別のウィンドウが表示されます。</p><p>Turbo Intruder も Burp Intruder と同様にペイロードポジションを設定する必要があります。
ここではダミー用のリクエストヘッダ(<code>x-dummy</code>)を用意し、ダミー用ヘッダの値に%s をセットしてペイロードポジションを設定します。</p><p>次にドロップダウンリストから「<code>examples/race.py</code>」を選択します。</p><p>デフォルトでは同時に 30 リクエスト送信する設定になっています。
例として 10 リクエスト送信したい場合は、9 行目の<code>range</code>関数の引数を修正します。</p><p><img src=./toctou_image5.png alt=toctou_image5></p><h2 id=事例紹介>事例紹介
<a class=anchor href=#%e4%ba%8b%e4%be%8b%e7%b4%b9%e4%bb%8b>#</a></h2><ul><li><a href=https://github.com/reddelexc/hackerone-reports/blob/master/tops_by_bug_type/TOPRACECONDITION.md>https://github.com/reddelexc/hackerone-reports/blob/master/tops_by_bug_type/TOPRACECONDITION.md</a></li></ul><h2 id=対策>対策
<a class=anchor href=#%e5%af%be%e7%ad%96>#</a></h2><p>データの整合性を保つ設計にする必要があります。しかしながら、Web アプリケーション毎に実装やデザインが異なるため、具体的な方法は多岐に分かれます。</p><ul><li>データのチェックからデータ更新までの一連の処理が完了するまで、ほかのスレッドやプロセスからアクセスできないようにしてください。</li><li>データベースで管理している場合はトランザクションを行い、読み書きする情報にロックを掛ける実装にしてください。<ul><li>ロックの範囲が広すぎると脆弱性の発生箇所とは異なる箇所でデッドロックが発生したり、トランザクション処理によってパフォーマンスにも影響を及ぼす可能性があるため注意してください。</li></ul></li></ul><h2 id=学習方法参考文献>学習方法/参考文献
<a class=anchor href=#%e5%ad%a6%e7%bf%92%e6%96%b9%e6%b3%95%e5%8f%82%e8%80%83%e6%96%87%e7%8c%ae>#</a></h2><ul><li><a href=https://timegaptheory.com/index.html>https://timegaptheory.com/index.html</a></li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/WebAppPentestGuidelines/newtechtestdoc/commit/528284dd5de3d7a9331aba11853c62ce912a25c2 title='最終更新者 wild0ni0n | March 22, 2023' target=_blank rel=noopener><img src=/newtechtestdoc/svg/calendar.svg class=book-icon alt=Calendar>
<span>March 22, 2023</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#概要>概要</a></li><li><a href=#原因>原因</a></li><li><a href=#影響>影響</a></li><li><a href=#診断観点攻撃手法>診断観点/攻撃手法</a><ul><li><a href=#burp-intruder-を使用した診断>Burp Intruder を使用した診断</a></li><li><a href=#turbo-intruder-を使用した診断>Turbo Intruder を使用した診断</a></li></ul></li><li><a href=#事例紹介>事例紹介</a></li><li><a href=#対策>対策</a></li><li><a href=#学習方法参考文献>学習方法/参考文献</a></li></ul></nav></div></aside></main></body></html>