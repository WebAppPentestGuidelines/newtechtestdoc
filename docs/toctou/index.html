<!doctype html><html lang=ja dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="TOCTOU/レースコンディション # 概要 # システム開発のセキュリティにおいてレースコンディションとTOCTOUは、しばしば混同して使われることがありますが、それぞれの違いについて用語の整理から確認していきましょう。
レースコンディション(race condition)とは、複数の処理が同じデータに対して同時にアクセスしたときに競合状態になることで、想定外の処理が引き起こされる問題です。
対してTime Of Check To Time Of Use(TOCTOU)とは、あるデータを使用する際に、データの状態をチェックする処理から実際にそのデータを使用する処理するまでの間に、データの状態が変化してしまうことで想定外の処理が引き起こされる問題です。
要約すると、レースコンディションは様々な競合状態の問題を表す包括的な脆弱性なのに対し、TOCTOUはより実装の状況を限定した具体的な脆弱性であることが分かります。
本章では、主にTOCTOUに関連する脆弱性や攻撃手法について説明します。
原因 # TOCTOUは主にデータのチェックとそのデータの使用するタイミングが異なっていることに起因しています。 そのため、TOCTOUを対策する考え方としては、データのチェックと使用を同時に行い、処理の差を発生させないようにすることが理想的です。
影響 # 代表的な脅威の例として、許可されていないデータへのアクセスや、回数制限などを超えて実行することを許してしまうような影響が考えられますが、データの内容や重要性、アプリケーションの振る舞いなどのビジネスロジックによってTOCTOUによる影響範囲は大きく異なります。
ここでは、TOCTOUが発生しやすい機能を例にあげます。
送金処理 クーポンやキャンペーンコード等の発行や使用 アカウントの新規登録 高評価、いいねボタンなどの投票機能 診断観点/攻撃手法 # 一般的に、DASTのようなツールを使用してTOCTOUの脆弱性を特定することは困難です。
これは、競合状態を引き起こした状態と正常なWebアプリケーションの振る舞いの違いを機械的に判断することは難しいためです。
また、TOCTOUの検査を行うためにはミリ秒単位で調整されたリクエスト送信や単一のHTTPパイプライン内で複数のHTTPリクエストを送る検査が必要になってくるため、Webアプリケーション診断に特化した専門ツール(Burpなど)が必要になるでしょう。
このように、競合状態を起こすための条件や環境を整える必要がある性質上、手動によるテストも他のWebアプリケーション脆弱性検査に比べて検査が難しいと考えられています。
TOCTOUの脆弱性を見つけるためには、データのチェック処理とデータを使用する処理が別のタイミングで行われている箇所を探しましょう。
具体的には、実行回数に制限があるような機能や重複防止の制限が設けられている機能などでTOCTOUの検査を行うことが有用です。
Burp Intruderを使用した検査 # Burp Intruderを使用してTOCTOUの検査を確認するパターンを紹介します。Burp IntruderはBurpに搭載されている機能の一つですが、Community Editionには機能制限があるためPro Editionでしか検査が行えません。Community Editionを使用する場合は、後述するTurbo Intruderを使用した検査方法をご覧ください。
はじめに、送信したいリクエストをBurp Intruderにセットします。
Burp Intruderを開始するにはペイロードポジションを設定する必要がありますが、ペイロードによる作用を防ぐため、ここではダミー用のリクエストヘッダー(x-dummy)を用意し、ダミー用ヘッダーの値にペイロードポジションを設定します。
次に、ペイロードの設定を行います。
Payload TypeをNull payloadsに設定します。
Generateの空白欄に送信したいリクエスト数を入力します。
デフォルトでは同時に10リクエストを送信します。
より多くのリクエストを送信したい場合は、Resource Pool設定から新しいリソースプール設定を作成し、Maximum concurrent requestsを設定してください。
Turbo Intruderを使用した検査 # Burp Suiteの拡張機能として公開されているTrubo Intruderを使用したパターンを紹介します。
Turbo Intruderは、大量のHTTPリクエストを送信したり、Pythonを使用して柔軟にリクエスト前後の処理を操作することができる拡張機能です。
また、Turbo Intruderは、標準のBurp Intruderとは異なりCommunity Editionでも使用することが可能です。"><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="Template"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="/docs/toctou/"><title>Template | WebApp Testing</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.c58292d36b18b675680ab9baea2029204537b839ea72f258746ec0f32ce8d6c8.css><script defer src=/flexsearch.min.js></script>
<script defer src=/ja.search.min.8c40eeae0d20d7c71c1916ae22acdc2db377c307eb032bf3647246d592c22879.js></script>
<script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js></script>
<link rel=alternate type=application/rss+xml href=/docs/toctou/index.xml title="WebApp Testing"></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>WebApp Testing</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=検索 aria-label=検索 maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div><ul><li><a href=/docs/oauth/>OAuth/OpenIDConnectの診断手法</a><ul></ul></li><li><a href=/docs/prototype_pollution/>Prototype Pollution</a><ul></ul></li><li><a href=/docs/toctou/ class=active>Template</a><ul></ul></li><li><a href=/docs/cloudsec/>クラウドサービスにおけるWebサービスにまつわる脆弱性</a><ul><li><a href=/docs/cloudsec/cloud_credential/>Webアプリケーションの脆弱性を利用した認証情報の窃取</a></li><li><a href=/docs/cloudsec/storage_service/>クラウドストレージサービスにおける設定不備</a></li></ul></li><li><a href=/docs/nosql_injection/nosqli/>Nosqli</a></li></ul></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>Template</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#概要>概要</a></li><li><a href=#原因>原因</a></li><li><a href=#影響>影響</a></li><li><a href=#診断観点攻撃手法>診断観点/攻撃手法</a><ul><li><a href=#burp-intruderを使用した検査>Burp Intruderを使用した検査</a></li><li><a href=#turbo-intruderを使用した検査>Turbo Intruderを使用した検査</a></li></ul></li><li><a href=#事例紹介>事例紹介</a></li><li><a href=#対策>対策</a></li><li><a href=#学習方法参考文献>学習方法/参考文献</a></li></ul></nav></aside></header><article class=markdown><h1 id=toctouレースコンディション>TOCTOU/レースコンディション
<a class=anchor href=#toctou%e3%83%ac%e3%83%bc%e3%82%b9%e3%82%b3%e3%83%b3%e3%83%87%e3%82%a3%e3%82%b7%e3%83%a7%e3%83%b3>#</a></h1><h2 id=概要>概要
<a class=anchor href=#%e6%a6%82%e8%a6%81>#</a></h2><p>システム開発のセキュリティにおいてレースコンディションとTOCTOUは、しばしば混同して使われることがありますが、それぞれの違いについて用語の整理から確認していきましょう。</p><p>レースコンディション(race condition)とは、複数の処理が同じデータに対して同時にアクセスしたときに競合状態になることで、想定外の処理が引き起こされる問題です。<br>対してTime Of Check To Time Of Use(TOCTOU)とは、あるデータを使用する際に、データの状態をチェックする処理から実際にそのデータを使用する処理するまでの間に、データの状態が変化してしまうことで想定外の処理が引き起こされる問題です。</p><p>要約すると、レースコンディションは様々な競合状態の問題を表す包括的な脆弱性なのに対し、TOCTOUはより実装の状況を限定した具体的な脆弱性であることが分かります。</p><p>本章では、主にTOCTOUに関連する脆弱性や攻撃手法について説明します。</p><h2 id=原因>原因
<a class=anchor href=#%e5%8e%9f%e5%9b%a0>#</a></h2><p>TOCTOUは主にデータのチェックとそのデータの使用するタイミングが異なっていることに起因しています。<br>そのため、TOCTOUを対策する考え方としては、データのチェックと使用を同時に行い、処理の差を発生させないようにすることが理想的です。</p><h2 id=影響>影響
<a class=anchor href=#%e5%bd%b1%e9%9f%bf>#</a></h2><p>代表的な脅威の例として、許可されていないデータへのアクセスや、回数制限などを超えて実行することを許してしまうような影響が考えられますが、データの内容や重要性、アプリケーションの振る舞いなどのビジネスロジックによってTOCTOUによる影響範囲は大きく異なります。</p><p>ここでは、TOCTOUが発生しやすい機能を例にあげます。</p><ul><li>送金処理</li><li>クーポンやキャンペーンコード等の発行や使用</li><li>アカウントの新規登録</li><li>高評価、いいねボタンなどの投票機能</li></ul><h2 id=診断観点攻撃手法>診断観点/攻撃手法
<a class=anchor href=#%e8%a8%ba%e6%96%ad%e8%a6%b3%e7%82%b9%e6%94%bb%e6%92%83%e6%89%8b%e6%b3%95>#</a></h2><p>一般的に、DASTのようなツールを使用してTOCTOUの脆弱性を特定することは困難です。<br>これは、競合状態を引き起こした状態と正常なWebアプリケーションの振る舞いの違いを機械的に判断することは難しいためです。</p><p>また、TOCTOUの検査を行うためにはミリ秒単位で調整されたリクエスト送信や単一のHTTPパイプライン内で複数のHTTPリクエストを送る検査が必要になってくるため、Webアプリケーション診断に特化した専門ツール(Burpなど)が必要になるでしょう。<br>このように、競合状態を起こすための条件や環境を整える必要がある性質上、手動によるテストも他のWebアプリケーション脆弱性検査に比べて検査が難しいと考えられています。</p><p>TOCTOUの脆弱性を見つけるためには、データのチェック処理とデータを使用する処理が別のタイミングで行われている箇所を探しましょう。<br>具体的には、実行回数に制限があるような機能や重複防止の制限が設けられている機能などでTOCTOUの検査を行うことが有用です。</p><h3 id=burp-intruderを使用した検査>Burp Intruderを使用した検査
<a class=anchor href=#burp-intruder%e3%82%92%e4%bd%bf%e7%94%a8%e3%81%97%e3%81%9f%e6%a4%9c%e6%9f%bb>#</a></h3><p>Burp Intruderを使用してTOCTOUの検査を確認するパターンを紹介します。Burp IntruderはBurpに搭載されている機能の一つですが、Community Editionには機能制限があるためPro Editionでしか検査が行えません。Community Editionを使用する場合は、後述するTurbo Intruderを使用した検査方法をご覧ください。</p><p>はじめに、送信したいリクエストをBurp Intruderにセットします。<br>Burp Intruderを開始するにはペイロードポジションを設定する必要がありますが、ペイロードによる作用を防ぐため、ここではダミー用のリクエストヘッダー(<code>x-dummy</code>)を用意し、ダミー用ヘッダーの値にペイロードポジションを設定します。</p><p><img src=./toctou_image1.png alt=toctou_image1></p><p>次に、ペイロードの設定を行います。<br><code>Payload Type</code>を<code>Null payloads</code>に設定します。<br>Generateの空白欄に送信したいリクエスト数を入力します。</p><p><img src="./toctou_image2.png?width=50pc" alt=toctou_image2></p><p>デフォルトでは同時に10リクエストを送信します。<br>より多くのリクエストを送信したい場合は、<code>Resource Pool</code>設定から新しいリソースプール設定を作成し、<code>Maximum concurrent requests</code>を設定してください。</p><p><img src=./toctou_image3.png alt=toctou_image3></p><h3 id=turbo-intruderを使用した検査>Turbo Intruderを使用した検査
<a class=anchor href=#turbo-intruder%e3%82%92%e4%bd%bf%e7%94%a8%e3%81%97%e3%81%9f%e6%a4%9c%e6%9f%bb>#</a></h3><p>Burp Suiteの拡張機能として公開されているTrubo Intruderを使用したパターンを紹介します。<br>Turbo Intruderは、大量のHTTPリクエストを送信したり、Pythonを使用して柔軟にリクエスト前後の処理を操作することができる拡張機能です。<br>また、Turbo Intruderは、標準のBurp Intruderとは異なりCommunity Editionでも使用することが可能です。</p><blockquote class="book-hint info"><strong>注意</strong><br>Turbo Intruderは、Port Swigger社のセキュリティリサーチャーであるJames Kettle氏によって開発されていますが、十分なテストが行われていないためBurpの標準機能よりも信頼性がなく、システムパフォーマンスに影響を及ぼす可能性があるため、拡張機能を使用される際には自己責任でお願い致します。</blockquote><p>送信したいリクエストを選択し、コンテキストメニューから<code>Extensions</code>-><code>Turbo Intruder</code>-><code>Send to turbo intruder</code>をクリックして、Turbo Intruderへリクエストを送ります。</p><p><img src=./toctou_image4.png alt=toctou_image4></p><p>別のウィンドウが表示されます。<br>Turbo IntruderもBurp Intruderと同様にペイロードポジションを設定する必要があります。ここではダミー用のリクエストヘッダー(<code>x-dummy</code>)を用意し、ダミー用ヘッダーの値に%sをセットしてペイロードポジションを設定します。<br>次にドロップダウンリストから「<code>examples/race.py</code>」を選択します。<br>デフォルトでは同時に30リクエスト送信する設定になっています。例として10リクエスト送信したい場合は、9行目の<code>range</code>関数の引数を修正します。</p><p><img src=./toctou_image5.png alt=toctou_image5></p><h2 id=事例紹介>事例紹介
<a class=anchor href=#%e4%ba%8b%e4%be%8b%e7%b4%b9%e4%bb%8b>#</a></h2><ul><li><a href=https://github.com/reddelexc/hackerone-reports/blob/master/tops_by_bug_type/TOPRACECONDITION.md>https://github.com/reddelexc/hackerone-reports/blob/master/tops_by_bug_type/TOPRACECONDITION.md</a></li></ul><h2 id=対策>対策
<a class=anchor href=#%e5%af%be%e7%ad%96>#</a></h2><p>データの整合性を保つ設計を行う必要があります。しかしながら、Webアプリケーション毎によって実装やデザインが異なるため、具体的な方法は多岐に分かれます。</p><p>考えられる対策として、データのチェックからデータ更新までの一連の処理が完了するまで、他のスレッドやプロセスからアクセスできないようにしてください。<br>データベースで管理している場合はトランザクションを行い、読み書きする情報にロックを掛ける実装にしてください。<br>ただし、ロックの範囲が広すぎると脆弱性発生箇所とは異なる箇所でデッドロックが発生したり、トランザクション処理によってパフォーマンスにも影響を及ぼす可能性があるため注意してください。</p><h2 id=学習方法参考文献>学習方法/参考文献
<a class=anchor href=#%e5%ad%a6%e7%bf%92%e6%96%b9%e6%b3%95%e5%8f%82%e8%80%83%e6%96%87%e7%8c%ae>#</a></h2><ul><li><a href=https://timegaptheory.com/index.html>https://timegaptheory.com/index.html</a></li></ul></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/WebAppPentestGuidelines/newtechtestdoc/commit/42d61f23c151d423be5351d7abe0c18ce3cb2e3e title='最終更新者 kazu1130 | February 24, 2023' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt=Calendar>
<span>February 24, 2023</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#概要>概要</a></li><li><a href=#原因>原因</a></li><li><a href=#影響>影響</a></li><li><a href=#診断観点攻撃手法>診断観点/攻撃手法</a><ul><li><a href=#burp-intruderを使用した検査>Burp Intruderを使用した検査</a></li><li><a href=#turbo-intruderを使用した検査>Turbo Intruderを使用した検査</a></li></ul></li><li><a href=#事例紹介>事例紹介</a></li><li><a href=#対策>対策</a></li><li><a href=#学習方法参考文献>学習方法/参考文献</a></li></ul></nav></div></aside></main></body></html>