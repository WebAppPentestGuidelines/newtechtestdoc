<!doctype html><html lang=ja dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="OAuth/OpenIDConnectの診断手法 # 概要 # 本章では、OAuth2.0およびOpenIDConnectと、それに関連するしくみについての脆弱性や攻撃手法について説明します。 なお、本ドキュメントに記載する用語、パラメータ名などはRFC 6749およびOpenID Connect Core 1.0 incorporating errata set 1の記載に準拠します。
OAtuh2.0 # OAuth2.0は、リソースサーバや認可サーバから見てサードパーティとなるクライアントサーバやアプリケーション等が、その認可に応じてリソースサーバに保存されているリソースオーナの情報を得るための認可フレームワークです。 通常のアプリケーションのようにクライアント/サーバだけではなく、認可サーバ/リソースサーバを含めた三者間の関係でセキュリティを考慮する必要があります。そのため、各パラメータの目的を考えながら、仕様通り正しく実装する必要があります。
以下では代表的な脆弱性の概要や診断手法について記載します。
オープンリダイレクタ # 概要 # 認可サーバでの認可が完了すると、リソースオーナのブラウザはredirect_uriパラメータで指定されたURLへリダイレクトされます。このリダイレクト時にオープンリダイレクタの脆弱性が存在すると、リソースオーナのブラウザが攻撃者の管理するサーバへリダイレクトされ、認可コード／アクセストークンが漏えいします。
原因と影響 # Authorization Code Grantを利用しているネイティブアプリケーションがPKCEを利用していない、もしくは認可サーバがPKCEに対応していないことが原因です。 この攻撃によって認可コードが漏えいした場合、正規のアプリケーションになりすまして不正にアクセストークンを発行される可能性があります。
診断観点 # 診断時においては、ネイティブアプリケーションからのOAuthのフロー開始後、PKCE関連のパラメータが送信されているか、送信されている場合にその値が適切に検証されているかを検査する必要があります。
認可リクエストにおいては、code_challengeおよびcode_challenge_methodパラメータが送信されているかを確認します。もし送信されている場合には、いずれか一方の値を適当な値に改ざんしてもフローが正常に完了するか検査します。
トークンリクエストにおいては、code_verifierを含めないもしくは正規のcode_verifier以外の値に改ざんしてもフローが正常に完了するか検査します。
対策 # 認可コード横取り攻撃は認可サーバでの対策が必要です。 RFC 7636で策定されたPKCE(Proof Key for Code Exchange)に準拠した実装をします。また、自身を利用するクライアントに対して、PKCEに準拠した各パラメータの送信を必須として要求します。
クロスサイトリクエストフォージェリ # 概要 # OAuth2.0におけるstateパラメータは、端的にはCSRF攻撃を防ぐためのパラメータです。 本パラメータに着眼して認可コードフローを見ると、以下のようになります。
クライアントサーバは、stateとしてランダムな値を発行し、リソースオーナーのブラウザのセッションと紐づけて保存する ブラウザは、クライアントサーバから発行されたstateを含む認可サーバへのURLへアクセスする 認可サーバは、codeパラメータとともに(2)のリダイレクト時に受け取ったstateをURLに付与してブラウザをクライアントサーバへリダイレクトさせる クライアントサーバは、ブラウザからcodeとstateを受け取り、(1)で保存したstateと一致している場合は以降の処理を実施する このフローにおいてstateパラメータの検証を適切に行っていない場合、以下の手順で攻撃が可能となります。
攻撃者は、上記フローにのっとって発行された自身のcodeを用いて、そのcodeを付与して被害者ブラウザをクライアントサーバへリダイレクトさせるような罠サイトを作る 罠サイトにアクセスした被害者のセッションと攻撃者のcodeの組をクライアントサーバで処理される 被害者は、攻撃者のアカウントでログインした状態となる 原因と影響 # 前述の通り、原因は、クライアントサーバが、codeパラメータを受け取る際に、stateパラメータを検証していないことです。 これによって、攻撃者のアカウント向けに発行されたcodeパラメータを、被害者に強制させることができます。
この影響はサイトや機能によって異なります。 たとえば、会員登録後に他サイトのアカウントと連携設定することで当該サイトのアカウントで会員としてログインできる機能をもったサイトの場合を考えます。この場合、連携設定の際に攻撃者アカウントのcodeを被害者のセッションに強制することで、攻撃者アカウントで当該サイトに被害者としてログインできます。
診断観点 # 診断時においては、CSRFの観点からstateパラメータを検証する必要があります。
OAuthはその性質上セッションを維持したまま外部サイトからのGET等を受け付ける必要があります。このため、Samesite属性によってCSRFを防いでいるサイトであっても、CSRF可能となる場合があるので、注意が必要です。
対策 # 対策は、処理前に十分にランダムなstateを付与し、codeパラメータを処理する前にセッションから読み出したstateとリダイレクトによって送られてきたstateが同一であるかを検証することです。"><meta name=theme-color content="#FFFFFF"><meta name=color-scheme content="light dark"><meta property="og:title" content="OAuth/OpenIDConnectの診断手法"><meta property="og:description" content><meta property="og:type" content="website"><meta property="og:url" content="/oauth/"><title>OAuth/OpenIDConnectの診断手法 | WebApp Testing</title><link rel=manifest href=/manifest.json><link rel=icon href=/favicon.png type=image/x-icon><link rel=stylesheet href=/book.min.c58292d36b18b675680ab9baea2029204537b839ea72f258746ec0f32ce8d6c8.css><script defer src=/flexsearch.min.js></script>
<script defer src=/ja.search.min.5abc8c970cb18109a53fe77b631cda8db1cba89a4571201ae0a61cd0d3007e5e.js></script>
<script defer src=/sw.min.6f6f90fcb8eb1c49ec389838e6b801d0de19430b8e516902f8d75c3c8bd98739.js></script>
<link rel=alternate type=application/rss+xml href=/oauth/index.xml title="WebApp Testing"></head><body dir=ltr><input type=checkbox class="hidden toggle" id=menu-control>
<input type=checkbox class="hidden toggle" id=toc-control><main class="container flex"><aside class=book-menu><div class=book-menu-content><nav><h2 class=book-brand><a class="flex align-center" href=/><span>WebApp Testing</span></a></h2><div class=book-search><input type=text id=book-search-input placeholder=検索 aria-label=検索 maxlength=64 data-hotkeys=s/><div class="book-search-spinner hidden"></div><ul id=book-search-results></ul></div></nav><script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script></div></aside><div class=book-page><header class=book-header><div class="flex align-center justify-between"><label for=menu-control><img src=/svg/menu.svg class=book-icon alt=Menu></label>
<strong>OAuth/OpenIDConnectの診断手法</strong>
<label for=toc-control><img src=/svg/toc.svg class=book-icon alt="Table of Contents"></label></div><aside class="hidden clearfix"><nav id=TableOfContents><ul><li><a href=#概要>概要</a></li></ul><ul><li><a href=#オープンリダイレクタ>オープンリダイレクタ</a><ul><li><a href=#概要-1>概要</a></li><li><a href=#原因と影響>原因と影響</a></li><li><a href=#診断観点>診断観点</a></li><li><a href=#対策>対策</a></li></ul></li><li><a href=#クロスサイトリクエストフォージェリ>クロスサイトリクエストフォージェリ</a><ul><li><a href=#概要-2>概要</a></li><li><a href=#原因と影響-1>原因と影響</a></li><li><a href=#診断観点-1>診断観点</a></li><li><a href=#対策-1>対策</a></li></ul></li><li><a href=#クライアント認証の不備>クライアント認証の不備</a><ul><li><a href=#概要-3>概要</a></li><li><a href=#原因と影響-2>原因と影響</a></li><li><a href=#診断観点-2>診断観点</a></li><li><a href=#対策-2>対策</a></li></ul></li><li><a href=#implicit-grant-flowをサーバと関係した処理で用いる>Implicit Grant Flowをサーバと関係した処理で用いる</a><ul><li><a href=#概要-4>概要</a></li><li><a href=#原因と影響-3>原因と影響</a></li><li><a href=#対策-3>対策</a></li></ul></li></ul><ul><li><a href=#idtokenの検証不備>IDTokenの検証不備</a><ul><li><a href=#概要-5>概要</a></li><li><a href=#原因と影響-4>原因と影響</a></li><li><a href=#診断観点-3>診断観点</a></li><li><a href=#対策-4>対策</a></li></ul></li><li><a href=#リプレイアタック>リプレイアタック</a><ul><li><a href=#概要-6>概要</a></li><li><a href=#原因と影響-5>原因と影響</a></li><li><a href=#診断観点-4>診断観点</a></li><li><a href=#対策-5>対策</a></li></ul></li></ul></nav></aside></header><article class=markdown><h1 id=oauthopenidconnectの診断手法>OAuth/OpenIDConnectの診断手法
<a class=anchor href=#oauthopenidconnect%e3%81%ae%e8%a8%ba%e6%96%ad%e6%89%8b%e6%b3%95>#</a></h1><h2 id=概要>概要
<a class=anchor href=#%e6%a6%82%e8%a6%81>#</a></h2><p>本章では、OAuth2.0およびOpenIDConnectと、それに関連するしくみについての脆弱性や攻撃手法について説明します。
なお、本ドキュメントに記載する用語、パラメータ名などはRFC 6749およびOpenID Connect Core 1.0 incorporating errata set 1の記載に準拠します。</p><h1 id=oatuh20>OAtuh2.0
<a class=anchor href=#oatuh20>#</a></h1><p>OAuth2.0は、リソースサーバや認可サーバから見てサードパーティとなるクライアントサーバやアプリケーション等が、その認可に応じてリソースサーバに保存されているリソースオーナの情報を得るための認可フレームワークです。
通常のアプリケーションのようにクライアント/サーバだけではなく、認可サーバ/リソースサーバを含めた三者間の関係でセキュリティを考慮する必要があります。そのため、各パラメータの目的を考えながら、仕様通り正しく実装する必要があります。</p><p>以下では代表的な脆弱性の概要や診断手法について記載します。</p><h2 id=オープンリダイレクタ>オープンリダイレクタ
<a class=anchor href=#%e3%82%aa%e3%83%bc%e3%83%97%e3%83%b3%e3%83%aa%e3%83%80%e3%82%a4%e3%83%ac%e3%82%af%e3%82%bf>#</a></h2><h3 id=概要-1>概要
<a class=anchor href=#%e6%a6%82%e8%a6%81-1>#</a></h3><p>認可サーバでの認可が完了すると、リソースオーナのブラウザはredirect_uriパラメータで指定されたURLへリダイレクトされます。このリダイレクト時にオープンリダイレクタの脆弱性が存在すると、リソースオーナのブラウザが攻撃者の管理するサーバへリダイレクトされ、認可コード／アクセストークンが漏えいします。</p><h3 id=原因と影響>原因と影響
<a class=anchor href=#%e5%8e%9f%e5%9b%a0%e3%81%a8%e5%bd%b1%e9%9f%bf>#</a></h3><p>Authorization Code Grantを利用しているネイティブアプリケーションがPKCEを利用していない、もしくは認可サーバがPKCEに対応していないことが原因です。
この攻撃によって認可コードが漏えいした場合、正規のアプリケーションになりすまして不正にアクセストークンを発行される可能性があります。</p><h3 id=診断観点>診断観点
<a class=anchor href=#%e8%a8%ba%e6%96%ad%e8%a6%b3%e7%82%b9>#</a></h3><p>診断時においては、ネイティブアプリケーションからのOAuthのフロー開始後、PKCE関連のパラメータが送信されているか、送信されている場合にその値が適切に検証されているかを検査する必要があります。</p><p>認可リクエストにおいては、code_challengeおよびcode_challenge_methodパラメータが送信されているかを確認します。もし送信されている場合には、いずれか一方の値を適当な値に改ざんしてもフローが正常に完了するか検査します。</p><p>トークンリクエストにおいては、code_verifierを含めないもしくは正規のcode_verifier以外の値に改ざんしてもフローが正常に完了するか検査します。</p><h3 id=対策>対策
<a class=anchor href=#%e5%af%be%e7%ad%96>#</a></h3><p>認可コード横取り攻撃は認可サーバでの対策が必要です。
RFC 7636で策定されたPKCE(Proof Key for Code Exchange)に準拠した実装をします。また、自身を利用するクライアントに対して、PKCEに準拠した各パラメータの送信を必須として要求します。</p><h2 id=クロスサイトリクエストフォージェリ>クロスサイトリクエストフォージェリ
<a class=anchor href=#%e3%82%af%e3%83%ad%e3%82%b9%e3%82%b5%e3%82%a4%e3%83%88%e3%83%aa%e3%82%af%e3%82%a8%e3%82%b9%e3%83%88%e3%83%95%e3%82%a9%e3%83%bc%e3%82%b8%e3%82%a7%e3%83%aa>#</a></h2><h3 id=概要-2>概要
<a class=anchor href=#%e6%a6%82%e8%a6%81-2>#</a></h3><p>OAuth2.0におけるstateパラメータは、端的にはCSRF攻撃を防ぐためのパラメータです。
本パラメータに着眼して認可コードフローを見ると、以下のようになります。</p><ol><li>クライアントサーバは、stateとしてランダムな値を発行し、リソースオーナーのブラウザのセッションと紐づけて保存する</li><li>ブラウザは、クライアントサーバから発行されたstateを含む認可サーバへのURLへアクセスする</li><li>認可サーバは、codeパラメータとともに(2)のリダイレクト時に受け取ったstateをURLに付与してブラウザをクライアントサーバへリダイレクトさせる</li><li>クライアントサーバは、ブラウザからcodeとstateを受け取り、(1)で保存したstateと一致している場合は以降の処理を実施する</li></ol><p>このフローにおいてstateパラメータの検証を適切に行っていない場合、以下の手順で攻撃が可能となります。</p><ol><li>攻撃者は、上記フローにのっとって発行された自身のcodeを用いて、そのcodeを付与して被害者ブラウザをクライアントサーバへリダイレクトさせるような罠サイトを作る</li><li>罠サイトにアクセスした被害者のセッションと攻撃者のcodeの組をクライアントサーバで処理される</li><li>被害者は、攻撃者のアカウントでログインした状態となる</li></ol><h3 id=原因と影響-1>原因と影響
<a class=anchor href=#%e5%8e%9f%e5%9b%a0%e3%81%a8%e5%bd%b1%e9%9f%bf-1>#</a></h3><p>前述の通り、原因は、クライアントサーバが、codeパラメータを受け取る際に、stateパラメータを検証していないことです。
これによって、攻撃者のアカウント向けに発行されたcodeパラメータを、被害者に強制させることができます。</p><p>この影響はサイトや機能によって異なります。
たとえば、会員登録後に他サイトのアカウントと連携設定することで当該サイトのアカウントで会員としてログインできる機能をもったサイトの場合を考えます。この場合、連携設定の際に攻撃者アカウントのcodeを被害者のセッションに強制することで、攻撃者アカウントで当該サイトに被害者としてログインできます。</p><h3 id=診断観点-1>診断観点
<a class=anchor href=#%e8%a8%ba%e6%96%ad%e8%a6%b3%e7%82%b9-1>#</a></h3><p>診断時においては、CSRFの観点からstateパラメータを検証する必要があります。</p><p>OAuthはその性質上セッションを維持したまま外部サイトからのGET等を受け付ける必要があります。このため、Samesite属性によってCSRFを防いでいるサイトであっても、CSRF可能となる場合があるので、注意が必要です。</p><h3 id=対策-1>対策
<a class=anchor href=#%e5%af%be%e7%ad%96-1>#</a></h3><p>対策は、処理前に十分にランダムなstateを付与し、codeパラメータを処理する前にセッションから読み出したstateとリダイレクトによって送られてきたstateが同一であるかを検証することです。</p><h2 id=クライアント認証の不備>クライアント認証の不備
<a class=anchor href=#%e3%82%af%e3%83%a9%e3%82%a4%e3%82%a2%e3%83%b3%e3%83%88%e8%aa%8d%e8%a8%bc%e3%81%ae%e4%b8%8d%e5%82%99>#</a></h2><h3 id=概要-3>概要
<a class=anchor href=#%e6%a6%82%e8%a6%81-3>#</a></h3><p>アクセストークンリクエストは、アクセストークン取得のためにクライアントから認可サーバ宛に送信されるリクエストです。アクセストークンリクエスト時にはクライアント認証が必須とされており、ここでの認証に不備があると、正規のクライアントになりすましてアクセストークンを発行可能となります。</p><h3 id=原因と影響-2>原因と影響
<a class=anchor href=#%e5%8e%9f%e5%9b%a0%e3%81%a8%e5%bd%b1%e9%9f%bf-2>#</a></h3><p>認可サーバが、アクセストークンリクエスト受信時にクライアントへ認証を要求していないことが原因です。
このような場合、何らかの手段で漏えいした認可コードを用いて、正規のクライアントになりすましたアクセストークンを発行される可能性があります。</p><h3 id=診断観点-2>診断観点
<a class=anchor href=#%e8%a8%ba%e6%96%ad%e8%a6%b3%e7%82%b9-2>#</a></h3><p>認可サーバから得たアクセストークンをサーバに送信していたり、そのアクセストークンによって解決した情報をサーバに送信している場合は注意が必要です。その値が改ざん可能であることを留意した設計になっているか検証する必要があります。</p><h3 id=対策-2>対策
<a class=anchor href=#%e5%af%be%e7%ad%96-2>#</a></h3><p>アクセストークンリクエスト送信時に、クライアントへ認証を要求します。ここでの認証方式は厳密に指定されておらず、パスワード認証やクライアント証明書などが利用可能です。</p><h2 id=implicit-grant-flowをサーバと関係した処理で用いる>Implicit Grant Flowをサーバと関係した処理で用いる
<a class=anchor href=#implicit-grant-flow%e3%82%92%e3%82%b5%e3%83%bc%e3%83%90%e3%81%a8%e9%96%a2%e4%bf%82%e3%81%97%e3%81%9f%e5%87%a6%e7%90%86%e3%81%a7%e7%94%a8%e3%81%84%e3%82%8b>#</a></h2><h3 id=概要-4>概要
<a class=anchor href=#%e6%a6%82%e8%a6%81-4>#</a></h3><p>Implicitフローは認可サーバとリソースオーナーのユーザエージェントのみで構成されるアプリケーションにおいて使える機能です。このフローで得た情報をサーバに送信する場合、当該値はリソースオーナーによって改ざん可能であるため、信頼できない値として扱う必要があります。</p><h3 id=原因と影響-3>原因と影響
<a class=anchor href=#%e5%8e%9f%e5%9b%a0%e3%81%a8%e5%bd%b1%e9%9f%bf-3>#</a></h3><p>たとえばImplicitフローで得られたリソースオーナーの住所をサーバに送信して、リソースサーバから連携された身元情報として取り扱う場合を考えます。この場合攻撃者は、リソースサーバから得られた住所を改変して送信することで、リソースサーバによって検証されていない値を登録できます。</p><p>また、クライアントがアクセストークンをリソースオーナーのユーザエージェントから直接受け取っている場合、リソースオーナーは任意のアクセストークンを送信できます。よって当該クライアント向けに発行されたものであるか検証しない限り、攻撃者サーバを利用したユーザのアクセストークンを使って、対象サイト上の機能を悪用できる可能性があります。</p><h3 id=対策-3>対策
<a class=anchor href=#%e5%af%be%e7%ad%96-3>#</a></h3><p>認可サーバとリソースオーナのユーザエージェント以外が関与する場合はImplicitフローではなく、認可コードフローを用いてください。</p><h1 id=openid-connect>OpenID Connect
<a class=anchor href=#openid-connect>#</a></h1><p>OpenIDConnectにおいても、その一部はOAuth2.0と同様の処理であるため、その共通する処理に関しては前述の問題が起こり得ます。
ただし、OpenID Connect特有の問題もあります。以下ではその問題について解説します。</p><h2 id=idtokenの検証不備>IDTokenの検証不備
<a class=anchor href=#idtoken%e3%81%ae%e6%a4%9c%e8%a8%bc%e4%b8%8d%e5%82%99>#</a></h2><h3 id=概要-5>概要
<a class=anchor href=#%e6%a6%82%e8%a6%81-5>#</a></h3><p>OpenIDConnectにおいては、最終的にユーザのアイデンティティを証明するものとして、JsonWebTokenが発行されます。このトークンには発行元や発行先、有効期限などが保持されており、署名によって正当性を検証できるようになっています。
正当性検証を怠った場合、JWT改ざんによって、なりすまし等の被害を発生させる恐れがあります。</p><h3 id=原因と影響-4>原因と影響
<a class=anchor href=#%e5%8e%9f%e5%9b%a0%e3%81%a8%e5%bd%b1%e9%9f%bf-4>#</a></h3><p>トークンの署名検証に不備がある場合、攻撃者はトークンを改ざんできるため、JWT内のパラメータを改ざんすることで、なりすますことが可能です。alg:Noneを指定できる場合や、攻撃者にとって既知の鍵を用いている場合などが不備の典型例です。</p><h3 id=診断観点-3>診断観点
<a class=anchor href=#%e8%a8%ba%e6%96%ad%e8%a6%b3%e7%82%b9-3>#</a></h3><h4 id=alg-none>alg none
<a class=anchor href=#alg-none>#</a></h4><p>署名検証不備を狙う攻撃として著名なものにJWTヘッダのalgの値にnoneを設定し、署名検証を回避させるものがあります。IDトークンの検証者がnoneの設定を許容している場合、IDトークンに含まれるclaimの値を攻撃者が自由に改ざん可能となり、第三者へのなりすましが容易に可能となります。</p><h4 id=alg-hs256>alg hs256
<a class=anchor href=#alg-hs256>#</a></h4><p>noneがIdPによって拒否された場合、別のアルゴリズムを指定することで署名検証の不備を突破できる可能性があります。それはHS256です。改ざん対象のIDトークンの署名に用いられた秘密鍵と対になるIdPの公開鍵を特定し、その公開鍵を用いてIDトークンの署名を生成します。この時のIDトークンは、ヘッダのalgの値としてHS256を指定した新たなIDトークンとして生成します。署名に用いたIdPの公開鍵をkidパラメータなどで指定できる場合、IDトークンに含まれるclaimの値を攻撃者が自由に改ざん可能となり、第三者へのなりすましが容易に可能となります。</p><h3 id=対策-4>対策
<a class=anchor href=#%e5%af%be%e7%ad%96-4>#</a></h3><p>まず署名検証を正しく行う必要があります。自身がRPの場合、署名検証アルゴリズムは独自に実装せず、ライブラリ等を用いて検証しましょう。自身がidpを担う場合は、ライブラリ使用に加え、JWT署名専用の鍵を生成・保管し鍵を使いまわさないようにしてください。
　加えて、自身がRPの場合は利用しているidpが各クレームをどのように用いているか念のため確認することを推奨します。idpが推奨する利用法や実装に沿って認証機能を実装しましょう。自身がidpの場合は、仕様に沿って各クレームを実装してください。仕様書にないクレームを付与する場合は、その意味や想定される使い方を公開してください。</p><h2 id=リプレイアタック>リプレイアタック
<a class=anchor href=#%e3%83%aa%e3%83%97%e3%83%ac%e3%82%a4%e3%82%a2%e3%82%bf%e3%83%83%e3%82%af>#</a></h2><h3 id=概要-6>概要
<a class=anchor href=#%e6%a6%82%e8%a6%81-6>#</a></h3><p>リプレイアタックとは、すでにRPで利用されたIDトークンを再送することで、正規のユーザになりすましてRPへログインすることを試みる攻撃です。
すでに利用済みのIDトークンを利用することから、正規のOIDCフローが完了した後に懸念されます。</p><h3 id=原因と影響-5>原因と影響
<a class=anchor href=#%e5%8e%9f%e5%9b%a0%e3%81%a8%e5%bd%b1%e9%9f%bf-5>#</a></h3><p>リプレイアタックが発生する原因にはRPとOPそれぞれの実装不備が関与します。</p><h4 id=rp>RP
<a class=anchor href=#rp>#</a></h4><p>ユーザのセッションと紐づくnonceパラメータを認証リクエストに含めていない、もしくはトークンレスポンス受信時にnonceパラメータを削除していない、のいずれか一方でも満たしていないことが原因です。</p><h4 id=op>OP
<a class=anchor href=#op>#</a></h4><p>IDトークンのclaimに、認証リクエストで受け取ったnonceパラメータを含めていないことが原因です。
これによって、何らかの手段でIDトークンを入手した攻撃者によって、正規のユーザになりすましてRPへログインされる可能性があります。</p><h3 id=診断観点-4>診断観点
<a class=anchor href=#%e8%a8%ba%e6%96%ad%e8%a6%b3%e7%82%b9-4>#</a></h3><p>診断時においては、IDトークンの再送が可能であるかを検査します。
手順として、まず一度OIDCのフローを完了してIDトークンを発行します。その後、別のユーザとしてOIDCのフローをあらためて開始し、トークンレスポンス内のIDトークンを、最初に発行したIDトークンへ置き換えます。その結果、最初にIDトークンを発行したユーザとしてRPへログインに成功する場合、リプレイアタックが可能となります。</p><h3 id=対策-5>対策
<a class=anchor href=#%e5%af%be%e7%ad%96-5>#</a></h3><p>RPとOPのそれぞれで対策が必要です。</p><h4 id=rp-1>RP
<a class=anchor href=#rp-1>#</a></h4><p>以下3点のどちらの対応も必須です。</p><ul><li>ユーザのセッションに紐づく値を生成し、認証リクエストにnonceパラメータとして含める</li><li>IDトークンのclaim内のnonceパラメータとユーザのセッションに紐づく値が一致することを検証する</li><li>検証後にセッションからnonceに一致する値を削除する</li></ul><h4 id=op-1>OP
<a class=anchor href=#op-1>#</a></h4><p>認証リクエストにnonceパラメータが含まれている場合は、発行するIDトークンのclaimにそのnonceパラメータをそのまま含める。</p></article><footer class=book-footer><div class="flex flex-wrap justify-between"><div><a class="flex align-center" href=https://github.com/WebAppPentestGuidelines/newtechtestdoc/commit/3a8cfebf92ca24b74c43e574a8ae134d0c9a6dc9 title='最終更新者 kazu1130 | February 24, 2023' target=_blank rel=noopener><img src=/svg/calendar.svg class=book-icon alt=Calendar>
<span>February 24, 2023</span></a></div></div><script>(function(){function e(e){const t=window.getSelection(),n=document.createRange();n.selectNodeContents(e),t.removeAllRanges(),t.addRange(n)}document.querySelectorAll("pre code").forEach(t=>{t.addEventListener("click",function(){if(window.getSelection().toString())return;e(t.parentElement),navigator.clipboard&&navigator.clipboard.writeText(t.parentElement.textContent)})})})()</script></footer><div class=book-comments></div><label for=menu-control class="hidden book-menu-overlay"></label></div><aside class=book-toc><div class=book-toc-content><nav id=TableOfContents><ul><li><a href=#概要>概要</a></li></ul><ul><li><a href=#オープンリダイレクタ>オープンリダイレクタ</a><ul><li><a href=#概要-1>概要</a></li><li><a href=#原因と影響>原因と影響</a></li><li><a href=#診断観点>診断観点</a></li><li><a href=#対策>対策</a></li></ul></li><li><a href=#クロスサイトリクエストフォージェリ>クロスサイトリクエストフォージェリ</a><ul><li><a href=#概要-2>概要</a></li><li><a href=#原因と影響-1>原因と影響</a></li><li><a href=#診断観点-1>診断観点</a></li><li><a href=#対策-1>対策</a></li></ul></li><li><a href=#クライアント認証の不備>クライアント認証の不備</a><ul><li><a href=#概要-3>概要</a></li><li><a href=#原因と影響-2>原因と影響</a></li><li><a href=#診断観点-2>診断観点</a></li><li><a href=#対策-2>対策</a></li></ul></li><li><a href=#implicit-grant-flowをサーバと関係した処理で用いる>Implicit Grant Flowをサーバと関係した処理で用いる</a><ul><li><a href=#概要-4>概要</a></li><li><a href=#原因と影響-3>原因と影響</a></li><li><a href=#対策-3>対策</a></li></ul></li></ul><ul><li><a href=#idtokenの検証不備>IDTokenの検証不備</a><ul><li><a href=#概要-5>概要</a></li><li><a href=#原因と影響-4>原因と影響</a></li><li><a href=#診断観点-3>診断観点</a></li><li><a href=#対策-4>対策</a></li></ul></li><li><a href=#リプレイアタック>リプレイアタック</a><ul><li><a href=#概要-6>概要</a></li><li><a href=#原因と影響-5>原因と影響</a></li><li><a href=#診断観点-4>診断観点</a></li><li><a href=#対策-5>対策</a></li></ul></li></ul></nav></div></aside></main></body></html>